---
phase: 05-parent-operations-dashboard-and-exports
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/api/src/services/operations-dashboard.ts
  - packages/api/src/routers/operations.ts
  - packages/api/src/routers/index.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Dashboard metrics use person-level counting as canonical grain and match the phase-05 metric definitions exactly."
    - "Filter semantics (event/side/rsvpStatus with strict AND behavior) are centralized in one shared query path."
    - "Dashboard and export features consume the same base dataset contract to prevent count/export drift."
  artifacts:
    - path: packages/api/src/services/operations-dashboard.ts
      provides: Shared operations query service for metrics, filter application, and deterministic row projection
      min_lines: 220
      contains: export async function getOperationsDataset
    - path: packages/api/src/routers/operations.ts
      provides: Protected API procedures for dashboard metrics, filter options, and preview row counts
      min_lines: 120
      contains: export const operationsRouter
    - path: packages/api/src/routers/index.ts
      provides: App router composition export for operations domain
      contains: operations: operationsRouter
  key_links:
    - from: packages/api/src/services/operations-dashboard.ts
      to: packages/db/src/schema/guests.ts
      via: Invited and side-filtered person scope is derived from People/GuestUnit membership data
    - from: packages/api/src/services/operations-dashboard.ts
      to: packages/db/src/schema/rsvp.ts
      via: Responded/accepted/declined projections are sourced from current RSVP response state
---

<objective>
Create the shared backend contract for phase-05 operations metrics and filter semantics.

Purpose: Lock OPS-01/OPS-03 counting/filter invariants in one query path before UI and CSV flows are built.
Output: New operations service + router procedures returning live metrics, filtered dataset timestamps, and row-count previews.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/STATE.md
@.gsd/phases/05-parent-operations-dashboard-and-exports/05-CONTEXT.md
@packages/api/src/services/audience-builder.ts
@packages/api/src/routers/invites.ts
@packages/api/src/routers/website.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Implement shared operations dataset service</name>
  <files>packages/api/src/services/operations-dashboard.ts</files>
  <action>Implement a reusable dataset builder that applies event/side/rsvpStatus filters with strict AND semantics, computes invited/responded/accepted/declined/pending person-level counts, and returns a max-updated freshness timestamp for `Data as of` display.</action>
  <verify>Service returns metric totals and freshness metadata from one query path with no duplicated counting logic in callers.</verify>
  <done>Phase-05 count semantics are encoded once and reusable by dashboard + export workflows.</done>
</task>

<task type="auto">
  <name>Task 2: Expose operations metrics and preview endpoints</name>
  <files>packages/api/src/routers/operations.ts</files>
  <action>Add protected router procedures for dashboard metrics read, filter-option lookup, and preview row count reads. Validate filter inputs (`all` defaults, enum-safe values) and map them into the shared dataset service.</action>
  <verify>Router responses include count metrics, freshness timestamp, and row count preview computed by shared service.</verify>
  <done>Web app has typed backend endpoints for live dashboard reads and pre-export sizing.</done>
</task>

<task type="auto">
  <name>Task 3: Wire operations router into app router composition</name>
  <files>packages/api/src/routers/index.ts</files>
  <action>Register `operationsRouter` in root router composition and typed client contract exports.</action>
  <verify>`bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds with operations procedures available to web client.</verify>
  <done>Operations API domain is discoverable and type-safe for downstream UI plans.</done>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds.
- [ ] Metrics endpoint returns invited/responded/accepted/declined/pending and freshness timestamp.
- [ ] `rsvpStatus=pending` resolves via `invited - responded` semantics on current RSVP state.
- [ ] Preview row count endpoint reuses the same service path used by metrics.
</verification>

<success_criteria>
- All tasks completed.
- OPS-01 and OPS-03 backend contracts are implemented with deterministic filter/count behavior.
- Shared service prevents dashboard/export contract divergence.
</success_criteria>

<output>
After completion, create `.gsd/phases/05-parent-operations-dashboard-and-exports/05-01-SUMMARY.md`.
</output>
