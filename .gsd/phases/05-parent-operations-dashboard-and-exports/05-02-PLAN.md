---
phase: 05-parent-operations-dashboard-and-exports
plan: "02"
type: execute
wave: 1
depends_on: ["05-01"]
files_modified:
  - packages/api/src/services/operations-export.ts
  - packages/api/src/routers/operations.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "CSV export uses stable phase-05 header order with one row per intended person record."
    - "Export dataset reuses the same filter/query semantics as dashboard metrics."
    - "Row ordering is deterministic: event date -> side -> guest unit name -> person name."
  artifacts:
    - path: packages/api/src/services/operations-export.ts
      provides: CSV row mapper and serializer enforcing stable header order and deterministic sorting
      min_lines: 140
      contains: export const OPERATIONS_EXPORT_HEADERS
    - path: packages/api/src/routers/operations.ts
      provides: Protected export procedure returning CSV payload/metadata from shared dataset
      min_lines: 170
      contains: exportCsv
  key_links:
    - from: packages/api/src/services/operations-export.ts
      to: packages/api/src/services/operations-dashboard.ts
      via: Export rows are projected from the same filtered dataset contract used by dashboard metrics
    - from: packages/api/src/routers/operations.ts
      to: packages/api/src/services/operations-export.ts
      via: Export endpoint serializes deterministic vendor-ready CSV output
---

<objective>
Add deterministic vendor-ready CSV export APIs aligned with dashboard filtering.

Purpose: Fulfill OPS-02 without creating semantic drift between what operators see and what vendors receive.
Output: Export service + router endpoint that emits stable CSV headers, one row per person, deterministic ordering, and shared filter semantics.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/phases/05-parent-operations-dashboard-and-exports/05-CONTEXT.md
@.gsd/phases/05-parent-operations-dashboard-and-exports/05-01-PLAN.md
@packages/api/src/services/operations-dashboard.ts
@packages/api/src/routers/invites.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Implement operations CSV export serializer</name>
  <files>packages/api/src/services/operations-export.ts</files>
  <action>Create export-specific mapping/serialization that enforces stable headers (`event_id,event_title,event_date,side,guest_unit_id,guest_unit_name,delivery_phone_e164,person_id,person_name,rsvp_status,responded_at,last_invite_status,last_invite_at`), deterministic ordering, and explicit null/empty formatting rules.</action>
  <verify>Serializer produces identical header sequence and row ordering for repeated identical inputs.</verify>
  <done>Vendor-ready CSV projection contract is centralized and deterministic.</done>
</task>

<task type="auto">
  <name>Task 2: Add export endpoint on operations router</name>
  <files>packages/api/src/routers/operations.ts</files>
  <action>Expose protected `exportCsv` procedure that accepts same filter payload as metrics endpoint, pulls dataset via shared operations service, then serializes CSV via export service with matching preview row counts.</action>
  <verify>Endpoint returns CSV payload and metadata with row count aligned to preview endpoint for identical filters.</verify>
  <done>Backend export path is available with count-aligned semantics.</done>
</task>

<task type="auto">
  <name>Task 3: Add empty-dataset and null-field handling</name>
  <files>packages/api/src/services/operations-export.ts, packages/api/src/routers/operations.ts</files>
  <action>Ensure exports for empty filters still emit headers only, and nullable fields (`responded_at`, invite status timestamps) serialize consistently without schema drift.</action>
  <verify>CSV output remains parseable and contract-stable for both populated and empty datasets.</verify>
  <done>Export behavior is operationally safe across sparse/empty RSVP states.</done>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds.
- [ ] Export response headers exactly match the phase-05 contract order.
- [ ] Export row count equals preview row count for identical filter input.
- [ ] Empty export returns headers-only CSV with no placeholder content.
</verification>

<success_criteria>
- All tasks completed.
- OPS-02 backend CSV contract is stable, deterministic, and vendor-ready.
- Export logic is aligned with dashboard filter/query semantics.
</success_criteria>

<output>
After completion, create `.gsd/phases/05-parent-operations-dashboard-and-exports/05-02-SUMMARY.md`.
</output>
