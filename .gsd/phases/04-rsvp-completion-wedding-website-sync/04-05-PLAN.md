---
phase: 04-rsvp-completion-wedding-website-sync
plan: "05"
type: execute
wave: 4
depends_on: ["04-01", "04-02", "04-03", "04-04"]
files_modified:
  - packages/api/src/services/whatsapp-rsvp-handler.test.ts
  - packages/api/src/routers/website.test.ts
  - .gsd/phases/04-rsvp-completion-wedding-website-sync/04-VERIFICATION.md
autonomous: true
user_setup: []
must_haves:
  truths:
    - "WA-03 is behaviorally proven: RSVP can be completed within three interactions and supports update reentry."
    - "WEB-01/WEB-02/WEB-03 are verification-proven with concrete artifact and wiring evidence, not file-existence claims."
    - "Phase 04 exits with a pass/fail verdict and explicit residual-risk notes if any constraints remain."
  artifacts:
    - path: packages/api/src/services/whatsapp-rsvp-handler.test.ts
      provides: Automated tests covering inbound RSVP handling, step progression, and update-flow behavior
      min_lines: 100
      contains: describe("whatsapp rsvp handler")
    - path: packages/api/src/routers/website.test.ts
      provides: Automated tests for summary/protected partitioning, OTP gate behavior, and stale metadata exposure
      min_lines: 120
      contains: describe("website router")
    - path: .gsd/phases/04-rsvp-completion-wedding-website-sync/04-VERIFICATION.md
      provides: Phase verification report with must-have checks and checkpoint outcomes
      min_lines: 120
      contains: "## Verdict"
  key_links:
    - from: packages/api/src/services/whatsapp-rsvp-handler.test.ts
      to: packages/api/src/services/whatsapp-rsvp-handler.ts
      via: Tests prove conversation flow, persistence updates, and confirmation behavior
    - from: packages/api/src/routers/website.test.ts
      to: packages/api/src/routers/website.ts
      via: Tests prove invite-only access enforcement and stale/fresh website payload contracts
---

<objective>
Complete quality hardening and formal verification for phase-04 RSVP + website-sync outcomes.

Purpose: Prove WA-03, WEB-01, WEB-02, and WEB-03 with automated evidence plus a phase-level verification report.
Output: Targeted tests for RSVP and website routers, and a final `04-VERIFICATION.md` verdict artifact.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@~/.kilocode/rules/verification-patterns.md
@.gsd/templates/verification-report.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/phases/04-rsvp-completion-wedding-website-sync/04-02-PLAN.md
@.gsd/phases/04-rsvp-completion-wedding-website-sync/04-03-PLAN.md
@.gsd/phases/04-rsvp-completion-wedding-website-sync/04-04-PLAN.md
@packages/api/src/services/whatsapp-rsvp-handler.ts
@packages/api/src/routers/website.ts
@apps/web/src/routes/site.$weddingSlug.tsx
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add behavioral tests for WhatsApp RSVP handler and step constraints</name>
  <files>packages/api/src/services/whatsapp-rsvp-handler.test.ts</files>
  <action>Add tests validating three-step completion ceiling, person-level attendance updates, update reentry for already-responded invitees, and confirmation payload content. Include duplicate/out-of-order inbound event handling where applicable.</action>
  <verify>Targeted RSVP handler tests pass and fail when step guard logic is intentionally violated.</verify>
  <done>WA-03 behavior is regression-protected by automated tests.</done>
</task>

<task type="auto">
  <name>Task 2: Add website router access/sync behavior tests</name>
  <files>packages/api/src/routers/website.test.ts</files>
  <action>Add tests for summary-only fallback, OTP-gated protected reads, trusted-session persistence boundaries, stale-state metadata exposure, and CTA state projection fields needed by web route logic.</action>
  <verify>Website router tests pass with deterministic assertions for protected-vs-summary data and stale metadata fields.</verify>
  <done>WEB-01/WEB-02/WEB-03 backend contracts are test-proven.</done>
</task>

<task type="auto">
  <name>Task 3: Produce phase verification report</name>
  <files>.gsd/phases/04-rsvp-completion-wedding-website-sync/04-VERIFICATION.md</files>
  <action>Run artifact/substance/wiring checks across all phase-04 plans, include human checkpoint outcome from website UX verification, and issue explicit pass/fail verdict with severity-tagged risks and mitigations if needed.</action>
  <verify>Verification report includes evidence-backed status for WA-03, WEB-01, WEB-02, WEB-03 and a clear final verdict section.</verify>
  <done>Phase 04 completion status is decision-ready with traceable evidence.</done>
</task>
</tasks>

<verification>
- [ ] `bun test packages/api/src/services/whatsapp-rsvp-handler.test.ts packages/api/src/routers/website.test.ts` passes.
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds.
- [ ] Human checkpoint result from `04-04` is captured in verification report.
- [ ] `04-VERIFICATION.md` declares clear verdict for WA-03/WEB-01/WEB-02/WEB-03.
</verification>

<success_criteria>
- All tasks completed.
- Automated tests prove core RSVP and website access/sync invariants.
- Phase 04 has a complete verification artifact with explicit verdict.
</success_criteria>

<output>
After completion, create `.gsd/phases/04-rsvp-completion-wedding-website-sync/04-05-SUMMARY.md`.
</output>
