---
phase: 04-rsvp-completion-wedding-website-sync
plan: "03"
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/api/src/services/website-sync.ts
  - packages/api/src/services/website-access.ts
  - packages/api/src/routers/website.ts
  - packages/api/src/routers/index.ts
  - packages/env/src/server.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Website data reads are sourced from canonical event + RSVP stores and refresh automatically after upstream changes."
    - "Invite-only website access uses phone OTP verification with trusted session persistence and does not expose protected event content to unauthorized visitors."
    - "When sync freshness degrades, API payload includes stale-state metadata (last updated + stale indicator) for banner rendering."
  artifacts:
    - path: packages/api/src/services/website-sync.ts
      provides: Canonical projection builder and freshness evaluator for website payloads
      min_lines: 140
      contains: export async function buildWebsiteSnapshot
    - path: packages/api/src/services/website-access.ts
      provides: OTP challenge verification and trusted-session policy helpers
      min_lines: 140
      contains: export async function verifyWebsiteOtp
    - path: packages/api/src/routers/website.ts
      provides: Public/invite-only website APIs with summary fallback and protected-detail reads
      min_lines: 180
      contains: export const websiteRouter
  key_links:
    - from: packages/api/src/routers/website.ts
      to: packages/api/src/services/website-sync.ts
      via: Website responses are generated from canonical sync service output
    - from: packages/api/src/routers/website.ts
      to: packages/api/src/services/website-access.ts
      via: Protected detail routes are gated through OTP/session verification
---

<objective>
Implement website synchronization and invite-only access policy services/APIs.

Purpose: Deliver WEB-01 and WEB-02 backend guarantees before front-end pages and CTA surfaces are built.
Output: Website router + supporting services for canonical snapshots, freshness signaling, OTP access, and protected/public partitioning.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/phases/04-rsvp-completion-wedding-website-sync/04-CONTEXT.md
@.gsd/phases/04-rsvp-completion-wedding-website-sync/04-01-PLAN.md
@packages/api/src/routers/events.ts
@packages/api/src/routers/invites.ts
@packages/api/src/policies/authorize.ts
@packages/env/src/server.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Build canonical website snapshot + freshness service</name>
  <files>packages/api/src/services/website-sync.ts</files>
  <action>Create service that composes published event details and RSVP aggregates from canonical tables, emitting a stable website snapshot contract plus freshness metadata (`lastUpdatedAt`, `isStale`, `lagSeconds`, `staleReason`).</action>
  <verify>Service returns consistent snapshot shape and freshness metadata updates after RSVP/event writes.</verify>
  <done>Website API can deliver auto-synced state with explicit freshness diagnostics.</done>
</task>

<task type="auto">
  <name>Task 2: Implement phone OTP invite-only access policy</name>
  <files>packages/api/src/services/website-access.ts, packages/env/src/server.ts</files>
  <action>Implement OTP challenge issue/verify helpers keyed by normalized phone and wedding scope, with trusted-device session persistence of 30 days. Add env validation for OTP expiry, attempt limits, and signing/secret material as needed.</action>
  <verify>OTP verification helpers enforce expiry/attempt limits and issue trusted-session tokens with expected TTL.</verify>
  <done>Invite-only access policy is enforceable and configurable through runtime env.</done>
</task>

<task type="auto">
  <name>Task 3: Expose website router with protected/public partitioning</name>
  <files>packages/api/src/routers/website.ts, packages/api/src/routers/index.ts</files>
  <action>Create website router endpoints for (a) public summary payload, (b) OTP start/verify, and (c) invite-only protected snapshot reads guarded by verified session. Ensure unauthorized callers only receive summary-level data and never schedule/venue/guest-sensitive content.</action>
  <verify>`bunx tsc --noEmit -p packages/api/tsconfig.json` passes and router is exported through app router composition.</verify>
  <done>Backend now supports auto-synced website payloads with invite-only policy enforcement.</done>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds.
- [ ] Website router exposes summary + protected endpoints with OTP/session gate.
- [ ] Snapshot payload includes stale-state metadata (`lastUpdatedAt`, `isStale`).
- [ ] Unauthorized requests receive summary-only output (no protected fields).
</verification>

<success_criteria>
- All tasks completed.
- WEB-01 and WEB-02 backend behavior is implemented and wired.
- Website access and freshness behavior is explicit, testable, and non-placeholder.
</success_criteria>

<output>
After completion, create `.gsd/phases/04-rsvp-completion-wedding-website-sync/04-03-SUMMARY.md`.
</output>
