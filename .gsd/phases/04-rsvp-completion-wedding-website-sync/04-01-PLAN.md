---
phase: 04-rsvp-completion-wedding-website-sync
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/rsvp.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/migrations/*.sql
autonomous: true
user_setup: []
must_haves:
  truths:
    - "RSVP progress and final responses are persisted as first-class records instead of inferred from invite delivery tables."
    - "Per-person attendance updates can be stored and re-opened for edits without losing historical confirmation state."
    - "Website sync freshness and stale-state signaling have explicit persisted metadata for runtime reads."
  artifacts:
    - path: packages/db/src/schema/rsvp.ts
      provides: RSVP flow/session, person-level response, and website sync state schema primitives
      min_lines: 220
      contains: export const rsvpFlowSessions
    - path: packages/db/src/schema/index.ts
      provides: Schema barrel export for RSVP domain
      contains: export * from "./rsvp"
    - path: packages/db/src/migrations
      provides: SQL migration artifacts for RSVP and website sync primitives
  key_links:
    - from: packages/db/src/schema/rsvp.ts
      to: packages/db/src/schema/whatsapp.ts
      via: RSVP flow records correlate to invite messages and provider references
    - from: packages/db/src/schema/rsvp.ts
      to: packages/db/src/schema/guests.ts
      via: Per-person RSVP entries are anchored to guest unit and person entities
---

<objective>
Create the persisted data foundation for WhatsApp RSVP completion and website synchronization.

Purpose: Lock WA-03 and WEB-01 data invariants before conversation handlers and website APIs are implemented.
Output: New RSVP schema module, exported db types, and generated migration SQL for flow sessions, person responses, and website freshness metadata.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/STATE.md
@.gsd/phases/04-rsvp-completion-wedding-website-sync/04-CONTEXT.md
@packages/db/src/schema/whatsapp.ts
@packages/db/src/schema/guests.ts
@packages/db/src/schema/events.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add RSVP and flow-session schema primitives</name>
  <files>packages/db/src/schema/rsvp.ts</files>
  <action>Create enums and tables for RSVP flow step progression (three-step contract), flow status, and final response state. Model session references to wedding/event/guest unit and store provider correlation identifiers needed by WhatsApp handlers.</action>
  <verify>Schema compiles with typed relations and includes explicit step index + completion fields.</verify>
  <done>RSVP interaction state can be persisted and queried without placeholder structures.</done>
</task>

<task type="auto">
  <name>Task 2: Add per-person attendance and website sync freshness primitives</name>
  <files>packages/db/src/schema/rsvp.ts</files>
  <action>Add person-level attendance records (accept/decline, updated-at, source metadata) and website sync status table(s) carrying last successful sync timestamp, lag seconds, stale flag, and last error detail for degraded-sync visibility.</action>
  <verify>Schema includes person-level attendance rows and freshness metadata that can drive stale banner behavior.</verify>
  <done>Data model supports both granular RSVP updates and website freshness diagnostics.</done>
</task>

<task type="auto">
  <name>Task 3: Export new schema and generate migration artifacts</name>
  <files>packages/db/src/schema/index.ts, packages/db/src/migrations/*.sql</files>
  <action>Wire RSVP schema into the schema barrel and run `bun run db:generate` so migration SQL is emitted. Ensure new indexes/uniques support flow lookup by wedding+event+phone and response lookup by guest unit/person.</action>
  <verify>`bun run db:generate` succeeds and generated SQL contains RSVP and sync tables with expected constraints.</verify>
  <done>Phase-04 data primitives are migration-backed and ready for API/runtime integration.</done>
</task>
</tasks>

<verification>
- [ ] `bun run db:generate` succeeds and emits RSVP-related migration SQL.
- [ ] `bunx tsc --noEmit -p packages/db/tsconfig.json` succeeds.
- [ ] RSVP schema contains explicit three-step flow fields, final-state fields, and person-level attendance records.
- [ ] Website freshness schema contains last-updated + stale-signal fields.
</verification>

<success_criteria>
- All tasks completed.
- RSVP and website-sync persistence primitives are available to downstream API plans.
- No phase-04 feature relies on inferred or ephemeral state.
</success_criteria>

<output>
After completion, create `.gsd/phases/04-rsvp-completion-wedding-website-sync/04-01-SUMMARY.md`.
</output>
