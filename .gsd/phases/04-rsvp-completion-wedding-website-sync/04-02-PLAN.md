---
phase: 04-rsvp-completion-wedding-website-sync
plan: "02"
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/api/src/services/whatsapp-rsvp-flow.test.ts
  - packages/api/src/services/whatsapp-rsvp-flow.ts
  - packages/api/src/services/whatsapp-rsvp-handler.ts
  - packages/api/src/services/whatsapp-provider.ts
  - packages/api/src/services/whatsapp-webhook.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Invitee can complete RSVP in three or fewer WhatsApp interaction steps with deterministic state transitions."
    - "Already-responded invitees can re-enter an update flow and revise person-level attendance without creating duplicate active sessions."
    - "Confirmation response includes final accepted/declined breakdown and next-action guidance payload for user-facing WhatsApp output."
  artifacts:
    - path: packages/api/src/services/whatsapp-rsvp-flow.test.ts
      provides: Behavioral tests for three-step RSVP progression and update-flow reentry
      min_lines: 120
      contains: describe("whatsapp rsvp flow")
    - path: packages/api/src/services/whatsapp-rsvp-flow.ts
      provides: Pure RSVP flow state machine and transition guards
      min_lines: 140
      contains: export function advanceRsvpFlow
    - path: packages/api/src/services/whatsapp-rsvp-handler.ts
      provides: Handler that maps webhook/user inputs into flow-state updates and persisted responses
      min_lines: 140
      contains: export async function handleWhatsAppRsvpInput
  key_links:
    - from: packages/api/src/services/whatsapp-rsvp-handler.ts
      to: packages/api/src/services/whatsapp-webhook.ts
      via: Inbound WhatsApp message events route into RSVP flow handling
    - from: packages/api/src/services/whatsapp-rsvp-handler.ts
      to: packages/api/src/services/whatsapp-provider.ts
      via: Confirmation/update prompts are emitted as outbound WhatsApp template or interactive messages
---

<objective>
Implement and harden the WhatsApp RSVP conversation engine with a strict three-step interaction contract.

Purpose: Deliver WA-03 behavior at the domain/service layer before website UX and CTA integration.
Output: Tested RSVP flow state machine plus webhook-connected handler for start/update/final-confirmation paths.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@~/.kilocode/rules/tdd.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/phases/04-rsvp-completion-wedding-website-sync/04-CONTEXT.md
@.gsd/phases/04-rsvp-completion-wedding-website-sync/04-01-PLAN.md
@packages/api/src/services/whatsapp-webhook.ts
@packages/api/src/services/whatsapp-provider.ts
@packages/db/src/schema/rsvp.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add failing and passing tests for three-step RSVP flow</name>
  <files>packages/api/src/services/whatsapp-rsvp-flow.test.ts</files>
  <action>Add test cases for: (a) new invitee step progression from start to final confirmation, (b) per-person attendance edits in step 2, (c) update-flow reentry after prior completion, and (d) blocked regressions or duplicate replay handling. Use explicit step-count assertions to enforce the <=3 interaction contract.</action>
  <verify>Targeted test file fails before implementation and passes after flow logic is added.</verify>
  <done>Flow behavior is regression-protected by explicit three-step tests.</done>
</task>

<task type="auto">
  <name>Task 2: Implement RSVP flow state machine and persistence handler</name>
  <files>packages/api/src/services/whatsapp-rsvp-flow.ts, packages/api/src/services/whatsapp-rsvp-handler.ts</files>
  <action>Implement pure transition helpers plus persistence-aware handler that creates/updates active flow sessions and per-person responses. Enforce one active RSVP session per wedding+event+phone and last-write-wins updates with audit-friendly metadata.</action>
  <verify>Tests pass and handler returns structured prompt/confirmation payloads for each flow step.</verify>
  <done>Inbound RSVP events deterministically advance or update flow state with persisted records.</done>
</task>

<task type="auto">
  <name>Task 3: Wire handler into webhook and outbound provider prompts</name>
  <files>packages/api/src/services/whatsapp-webhook.ts, packages/api/src/services/whatsapp-provider.ts</files>
  <action>Extend webhook processing to detect RSVP interaction payloads and route them into the RSVP handler. Add provider helper(s) for RSVP prompts/confirmations so responses include meaningful next actions and not just storage acknowledgements.</action>
  <verify>`bunx tsc --noEmit -p packages/api/tsconfig.json` passes and webhook path invokes RSVP handler for relevant inbound events.</verify>
  <done>WhatsApp inbound/outbound paths support full RSVP completion and update loops.</done>
</task>
</tasks>

<verification>
- [ ] `bun test packages/api/src/services/whatsapp-rsvp-flow.test.ts` passes.
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds.
- [ ] Webhook handler routes RSVP inbound payloads into flow transitions.
- [ ] Confirmation payload includes final attendance summary + next-action guidance.
</verification>

<success_criteria>
- All tasks completed.
- WA-03 conversation behavior is test-proven and deterministic.
- Update-flow reentry works without duplicate active sessions.
</success_criteria>

<output>
After completion, create `.gsd/phases/04-rsvp-completion-wedding-website-sync/04-02-SUMMARY.md`.
</output>
