---
phase: 04-rsvp-completion-wedding-website-sync
plan: "04"
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - apps/web/src/routes/site.$weddingSlug.tsx
  - apps/web/src/routes/site.$weddingSlug.verify.tsx
  - apps/web/src/components/website/rsvp-sticky-cta.tsx
  - apps/web/src/components/website/stale-sync-banner.tsx
  - apps/web/src/routeTree.gen.ts
autonomous: false
user_setup: []
must_haves:
  truths:
    - "Website surfaces a single sticky WhatsApp RSVP CTA with state-aware labels (`Complete RSVP` vs `Update RSVP`)."
    - "Invite-only pages require OTP verification before rendering protected schedule/venue/guest content, while unauthenticated users still see summary-level data."
    - "When backend marks data stale, website visibly shows stale banner and last-updated timestamp."
  artifacts:
    - path: apps/web/src/routes/site.$weddingSlug.tsx
      provides: Public/invite-only wedding website page with summary fallback and protected sections
      min_lines: 180
      contains: createFileRoute("/site/$weddingSlug")
    - path: apps/web/src/components/website/rsvp-sticky-cta.tsx
      provides: Stateful sticky RSVP CTA component routing to start/update WhatsApp flow intents
      min_lines: 90
      contains: export function RsvpStickyCta
    - path: apps/web/src/components/website/stale-sync-banner.tsx
      provides: Freshness warning UI showing last update timestamp and stale indicator
      min_lines: 50
      contains: export function StaleSyncBanner
  key_links:
    - from: apps/web/src/routes/site.$weddingSlug.tsx
      to: packages/api/src/routers/website.ts
      via: Website route consumes summary/protected snapshot APIs and OTP flow endpoints
    - from: apps/web/src/components/website/rsvp-sticky-cta.tsx
      to: packages/api/src/services/whatsapp-rsvp-handler.ts
      via: CTA intent routing maps to start/update RSVP flow states served by backend
---

<objective>
Build the wedding website UX surface with invite-only gating, stale-data transparency, and WhatsApp RSVP CTA wiring.

Purpose: Deliver WEB-02 and WEB-03 user-visible behavior on top of phase-04 backend services.
Output: Public/invite-only website routes, OTP verification screen, sticky RSVP CTA, and stale-sync banner components.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@~/.kilocode/rules/checkpoints.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/phases/04-rsvp-completion-wedding-website-sync/04-CONTEXT.md
@.gsd/phases/04-rsvp-completion-wedding-website-sync/04-02-PLAN.md
@.gsd/phases/04-rsvp-completion-wedding-website-sync/04-03-PLAN.md
@apps/web/src/routes/events.$eventId.tsx
@apps/web/src/routes/index.tsx
@apps/web/src/components/ui/card.tsx
</context>

<tasks>
<task type="auto">
  <name>Task 1: Build website route and OTP verification flow screens</name>
  <files>apps/web/src/routes/site.$weddingSlug.tsx, apps/web/src/routes/site.$weddingSlug.verify.tsx</files>
  <action>Create wedding website route that always shows public summary data and conditionally renders protected content only after verified OTP session. Add dedicated verification route to start and complete phone OTP flow tied to invite-only access policy APIs.</action>
  <verify>Routes compile, resolve through typed route params/search state, and query website router endpoints correctly.</verify>
  <done>Invite-only website mode is user-visible and enforces summary-vs-protected split.</done>
</task>

<task type="auto">
  <name>Task 2: Add stale-sync banner and state-aware sticky RSVP CTA components</name>
  <files>apps/web/src/components/website/stale-sync-banner.tsx, apps/web/src/components/website/rsvp-sticky-cta.tsx</files>
  <action>Implement reusable stale banner that displays `last updated` timestamp when data is stale. Implement sticky CTA component with dynamic labels and routing logic for new vs already-responded invitees; when flow unavailable, queue intent and show acknowledgement copy.</action>
  <verify>Component props are typed and route-level render uses API-driven state (no hardcoded RSVP labels/statuses).</verify>
  <done>Website clearly communicates freshness and provides correct WhatsApp RSVP call-to-action behavior.</done>
</task>

<task type="auto">
  <name>Task 3: Register routes and regenerate route tree</name>
  <files>apps/web/src/routeTree.gen.ts</files>
  <action>Integrate new website/verification routes into route graph and regenerate typed route tree artifacts.</action>
  <verify>`bun run --filter web build` succeeds with generated route tree in sync.</verify>
  <done>Website routes are type-safe and discoverable in app navigation graph.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Wedding website routes with OTP gating, stale banner, and sticky WhatsApp RSVP CTA</what-built>
  <how-to-verify>
    Visit the running web app and confirm:
    1. `/site/{weddingSlug}` shows public summary even when not verified.
    2. Protected sections prompt OTP verification and are hidden before verification.
    3. After OTP verification, protected schedule/venue details are visible.
    4. Sticky RSVP CTA appears and label changes by state (`Complete RSVP` vs `Update RSVP`).
    5. When API marks stale data, banner shows stale state and a visible `last updated` timestamp.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p apps/web/tsconfig.json` succeeds.
- [ ] `bun run --filter web build` succeeds.
- [ ] Website routes are present in generated route tree.
- [ ] Human verification confirms OTP gating, stale banner, and dynamic RSVP CTA behavior.
</verification>

<success_criteria>
- All tasks completed.
- WEB-02 and WEB-03 UI behavior is implemented and approved via checkpoint.
- Website exposes summary fallback while enforcing invite-only protected content access.
</success_criteria>

<output>
After completion, create `.gsd/phases/04-rsvp-completion-wedding-website-sync/04-04-SUMMARY.md`.
</output>
