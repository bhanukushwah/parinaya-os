---
phase: 06-gifts-basics-and-safety-controls
plan: "05"
type: execute
wave: 4
depends_on: ["06-01", "06-02", "06-03", "06-04"]
files_modified:
  - packages/api/src/services/gifts-lifecycle.test.ts
  - packages/api/src/services/gifts-contribution.test.ts
  - packages/api/src/routers/gifts.test.ts
  - .gsd/phases/06-gifts-basics-and-safety-controls/06-VERIFICATION.md
autonomous: true
user_setup: []
must_haves:
  truths:
    - "GFT-01 is verification-backed: invited guests can access published gifts details and contribute toward wishlist targets while non-invited users cannot."
    - "GFT-02 is verification-backed: publish/hide/disable and sensitive edits are role-restricted, audited, and enforce explicit failure responses when unauthorized."
    - "Contribution integrity is regression-tested for unavailable-state blocking and concurrent amount safety."
    - "Phase 06 exits with explicit pass/fail verdict including both dashboard and website human checkpoint outcomes."
  artifacts:
    - path: packages/api/src/services/gifts-lifecycle.test.ts
      provides: Lifecycle transition matrix tests including mandatory note, disable-to-draft recovery, and role authorization boundaries
      min_lines: 150
      contains: describe("gifts lifecycle service")
    - path: packages/api/src/services/gifts-contribution.test.ts
      provides: Contribution transaction behavior tests for state gating, remaining-target validation, and progress updates
      min_lines: 150
      contains: describe("gifts contribution service")
    - path: packages/api/src/routers/gifts.test.ts
      provides: Router-level tests for guest/admin projection split and explicit forbidden/validation errors
      min_lines: 140
      contains: describe("gifts router")
    - path: .gsd/phases/06-gifts-basics-and-safety-controls/06-VERIFICATION.md
      provides: Full phase verification report with artifact/substance/wiring checks and final verdict for GFT-01/GFT-02
      min_lines: 130
      contains: "## Verdict"
  key_links:
    - from: packages/api/src/services/gifts-lifecycle.test.ts
      to: packages/api/src/services/gifts-lifecycle.ts
      via: Tests prove locked transition + authorization + audit behaviors cannot regress
    - from: packages/api/src/services/gifts-contribution.test.ts
      to: packages/api/src/services/gifts-contribution.ts
      via: Tests prove transaction-safe contribution writes and unavailable-state enforcement
---

<objective>
Complete quality hardening and phase-level verification for gifts basics and safety controls.

Purpose: Provide evidence that Phase 06 outcomes satisfy GFT-01 and GFT-02 with automated and human verification.
Output: Gifts lifecycle/contribution/router tests plus final `06-VERIFICATION.md` verdict artifact.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@~/.kilocode/rules/verification-patterns.md
@.gsd/templates/verification-report.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/phases/06-gifts-basics-and-safety-controls/06-01-PLAN.md
@.gsd/phases/06-gifts-basics-and-safety-controls/06-02-PLAN.md
@.gsd/phases/06-gifts-basics-and-safety-controls/06-03-PLAN.md
@.gsd/phases/06-gifts-basics-and-safety-controls/06-04-PLAN.md
@packages/api/src/services/gifts-lifecycle.ts
@packages/api/src/services/gifts-contribution.ts
@packages/api/src/routers/gifts.ts
@apps/web/src/routes/dashboard.gifts.tsx
@apps/web/src/routes/site.$weddingSlug.tsx
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add lifecycle and authorization regression tests</name>
  <files>packages/api/src/services/gifts-lifecycle.test.ts</files>
  <action>Add tests covering allowed/blocked transitions (`draft->published`, `published->hidden`, `published/hidden->disabled`, `disabled->draft`), mandatory pre-publish note validation, explicit forbidden responses for unauthorized roles, and audit-event write assertions for publish/hide/disable/sensitive edits.</action>
  <verify>Tests fail on transition table regressions or missing audit writes and pass with correct lifecycle implementation.</verify>
  <done>Safety-control governance behavior is regression-protected.</done>
</task>

<task type="auto">
  <name>Task 2: Add contribution integrity + projection split tests</name>
  <files>packages/api/src/services/gifts-contribution.test.ts, packages/api/src/routers/gifts.test.ts</files>
  <action>Add tests proving contribution rejection for hidden/disabled/draft states, remaining-target amount validation, atomic raised-total updates, guest projection redaction of contributor identities, and admin projection visibility of contributor details.</action>
  <verify>Tests assert both integrity invariants and privacy boundaries for guest vs admin contracts.</verify>
  <done>GFT-01 contribution and privacy semantics are covered by automated evidence.</done>
</task>

<task type="auto">
  <name>Task 3: Produce Phase 06 verification report with checkpoint outcomes</name>
  <files>.gsd/phases/06-gifts-basics-and-safety-controls/06-VERIFICATION.md</files>
  <action>Run verification-pattern checks for schema/API/web artifacts, include results from dashboard (`06-03`) and website (`06-04`) human checkpoints, map findings to GFT-01/GFT-02, and publish an explicit pass/fail verdict with residual risks and mitigations.</action>
  <verify>Verification report contains evidence-backed requirement mapping and clear final verdict section.</verify>
  <done>Phase 06 completion status is decision-ready and traceable.</done>
</task>
</tasks>

<verification>
- [ ] `bun test packages/api/src/services/gifts-lifecycle.test.ts packages/api/src/services/gifts-contribution.test.ts packages/api/src/routers/gifts.test.ts` passes.
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds.
- [ ] `bunx tsc --noEmit -p apps/web/tsconfig.json` succeeds.
- [ ] `bunx tsc --noEmit -p apps/server/tsconfig.json` remains green after gifts router integration.
- [ ] `06-VERIFICATION.md` includes GFT-01/GFT-02 status, human checkpoint outcomes, and final verdict.
</verification>

<success_criteria>
- All tasks completed.
- Automated tests prove lifecycle, auth, privacy, and contribution integrity behaviors.
- Phase 06 verification artifact provides clear requirement-level pass/fail outcome.
</success_criteria>

<output>
After completion, create `.gsd/phases/06-gifts-basics-and-safety-controls/06-05-SUMMARY.md`.
</output>
