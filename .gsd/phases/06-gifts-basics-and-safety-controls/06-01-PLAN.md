---
phase: 06-gifts-basics-and-safety-controls
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/gifts.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/migrations/0005_gifts_baseline.sql
  - packages/db/src/migrations/meta/0005_snapshot.json
  - packages/api/src/services/audit-log.ts
  - packages/env/src/server.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Gift persistence uses a lifecycle state machine (`draft|published|hidden|disabled`) with transition-safe storage primitives instead of ad-hoc booleans."
    - "Wishlist contribution math is represented in integer paise and supports many partial contributions per item until target is reached."
    - "Critical gift actions (publish/hide/disable + sensitive edits) have explicit audit action taxonomy support before router wiring begins."
  artifacts:
    - path: packages/db/src/schema/gifts.ts
      provides: Gifts mode, wishlist items, contributions, and gift audit event schema with lifecycle and money constraints
      min_lines: 220
      contains: export const giftsModes
    - path: packages/db/src/migrations/0005_gifts_baseline.sql
      provides: Generated SQL migration for gifts schema tables, enums, indexes, and constraints
      min_lines: 140
      contains: CREATE TABLE "gifts_modes"
    - path: packages/api/src/services/audit-log.ts
      provides: Audit action constants extended for gifts critical actions
      contains: GIFT_PUBLISH
    - path: packages/env/src/server.ts
      provides: Server env contract for gifts freshness/unavailable messaging knobs used by API projections
      contains: GIFTS_STALE_THRESHOLD_SECONDS
  key_links:
    - from: packages/db/src/schema/gifts.ts
      to: .gsd/phases/06-gifts-basics-and-safety-controls/06-CONTEXT.md
      via: Lifecycle and contribution rules match locked publish/hide/disable and open partial-contribution decisions
    - from: packages/api/src/services/audit-log.ts
      to: packages/db/src/schema/governance.ts
      via: New gift action types reuse centralized audit log write pipeline
---

<objective>
Create the Phase 06 persistence and contracts foundation for gifts lifecycle, contribution accounting, and auditability.

Purpose: Encode locked gifts semantics into DB + env + audit primitives before API/UI flows are implemented.
Output: Gifts schema/migration artifacts, audit action constants, and env validation entries required by downstream plans.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/phases/06-gifts-basics-and-safety-controls/06-CONTEXT.md
@.gsd/phases/06-gifts-basics-and-safety-controls/06-RESEARCH.md
@packages/db/src/schema/rsvp.ts
@packages/db/src/schema/governance.ts
@packages/env/src/server.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add gifts domain schema with lifecycle + contribution primitives</name>
  <files>packages/db/src/schema/gifts.ts, packages/db/src/schema/index.ts</files>
  <action>Define gifts mode lifecycle enum/state columns, UPI detail fields, wishlist items with `targetAmountPaise`/`amountRaisedPaise`, contribution rows, and append-only gift audit event rows. Add indexes/constraints for wedding scoping, published visibility reads, and contribution lookups.</action>
  <verify>Schema exports compile and enforce integer money fields plus deterministic wedding-scoped relations.</verify>
  <done>Database primitives exist for phase-06 lifecycle, gifting content, and contribution history.</done>
</task>

<task type="auto">
  <name>Task 2: Generate migration and metadata snapshot</name>
  <files>packages/db/src/migrations/0005_gifts_baseline.sql, packages/db/src/migrations/meta/0005_snapshot.json</files>
  <action>Run migration generation after schema updates so SQL includes enum/table/index/check definitions for gifts mode, items, contributions, and gift audit events.</action>
  <verify>`bun run db:generate` emits migration + snapshot with gifts objects and no manual placeholder SQL.</verify>
  <done>Phase-06 schema is reproducibly migratable across environments.</done>
</task>

<task type="auto">
  <name>Task 3: Extend audit actions and env contract used by gifts projections</name>
  <files>packages/api/src/services/audit-log.ts, packages/env/src/server.ts</files>
  <action>Add gift action constants (`gift.publish`, `gift.hide`, `gift.disable`, `gift.edit`) and introduce typed env parsing for gifts staleness/unavailable projection controls consumed by API services.</action>
  <verify>API/env package typecheck succeeds with new constants/vars available to downstream services.</verify>
  <done>Shared contracts are ready for safe server-side gifts behavior implementation.</done>
</task>
</tasks>

<verification>
- [ ] `bun run db:generate` succeeds with new gifts migration artifacts.
- [ ] `bunx tsc --noEmit -p packages/db/tsconfig.json` succeeds.
- [ ] `bunx tsc --noEmit -p packages/env/tsconfig.json` succeeds.
- [ ] Gifts schema includes lifecycle enum and integer paise amount fields for wishlist + contributions.
</verification>

<success_criteria>
- All tasks completed.
- GFT-01 and GFT-02 foundations are persisted in schema/env/audit contracts.
- Downstream API and UI plans can consume lifecycle-safe, audit-ready primitives.
</success_criteria>

<output>
After completion, create `.gsd/phases/06-gifts-basics-and-safety-controls/06-01-SUMMARY.md`.
</output>
