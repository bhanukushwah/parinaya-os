---
phase: 06-gifts-basics-and-safety-controls
plan: "02"
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - packages/api/src/services/gifts-lifecycle.ts
  - packages/api/src/services/gifts-contribution.ts
  - packages/api/src/services/gifts-projection.ts
  - packages/api/src/routers/gifts.ts
  - packages/api/src/routers/website.ts
  - packages/api/src/routers/index.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Gift edit/publish/hide/disable actions are server-authorized to admin/coordinator with explicit forbidden errors for unauthorized actors."
    - "Publish is blocked unless mandatory pre-publish note is present, and disable recovery returns to draft requiring explicit re-publish."
    - "Contribution writes are transaction-safe and reject stale/unavailable states so disabled/hidden modes never accept new payments."
    - "Guest responses never expose contributor identities, while admin responses preserve contributor detail visibility."
  artifacts:
    - path: packages/api/src/services/gifts-lifecycle.ts
      provides: Lifecycle transition guards, role/resource authorization checks, and audit write orchestration for gift mode actions
      min_lines: 220
      contains: export async function transitionGiftsMode
    - path: packages/api/src/services/gifts-contribution.ts
      provides: Transactional contribution create flow with row locking and amount validation in paise
      min_lines: 170
      contains: export async function createGiftContribution
    - path: packages/api/src/routers/gifts.ts
      provides: Typed procedures for admin draft/edit, publish/hide/disable, guest read, and contribution submit
      min_lines: 240
      contains: export const giftsRouter
    - path: packages/api/src/services/gifts-projection.ts
      provides: Split guest/admin DTO projection with contributor redaction for guest-facing payloads
      min_lines: 120
      contains: export function projectGuestGiftsView
  key_links:
    - from: packages/api/src/routers/gifts.ts
      to: packages/db/src/schema/gifts.ts
      via: Router procedures map one-to-one to lifecycle + contribution persistence primitives
    - from: packages/api/src/routers/website.ts
      to: packages/api/src/services/website-access.ts
      via: Invite-only website trust session gating is reused for gifts guest payload access
---

<objective>
Implement the core Phase 06 gifts API domain with locked lifecycle, safety, authorization, and privacy semantics.

Purpose: Deliver backend truth for GFT-01/GFT-02 so operator actions and guest contributions are safe by default.
Output: New gifts router/service stack wired into app router, plus website snapshot integration for invite-only guest gift reads.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/REQUIREMENTS.md
@.gsd/phases/06-gifts-basics-and-safety-controls/06-CONTEXT.md
@.gsd/phases/06-gifts-basics-and-safety-controls/06-RESEARCH.md
@packages/api/src/routers/website.ts
@packages/api/src/services/website-access.ts
@packages/api/src/services/audit-log.ts
@packages/api/src/policies/authorize.ts
@packages/db/src/schema/gifts.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Implement lifecycle + authorization service for gifts mode actions</name>
  <files>packages/api/src/services/gifts-lifecycle.ts</files>
  <action>Build lifecycle transition service enforcing draft/published/hidden/disabled rules, locked pre-publish note requirement, disable-to-draft recovery behavior, and explicit role/resource checks (admin/coordinator only) with structured forbidden errors. Persist critical action audit events on successful transitions and sensitive edits.</action>
  <verify>Blocked transitions/unauthorized attempts fail deterministically; allowed transitions write audit records with before/after summaries.</verify>
  <done>Server holds canonical safety-control behavior for publish/hide/disable/edit actions.</done>
</task>

<task type="auto">
  <name>Task 2: Implement transactional contribution flow and projection split</name>
  <files>packages/api/src/services/gifts-contribution.ts, packages/api/src/services/gifts-projection.ts</files>
  <action>Implement contribution writes in one transaction (`SELECT ... FOR UPDATE` + remaining-target checks + atomic raised-amount update). Add projection helpers that hide contributor identities in guest payloads while preserving admin-level attribution.</action>
  <verify>Concurrent contribution paths cannot overrun targets and guest payloads contain totals/progress only.</verify>
  <done>Contribution integrity and privacy boundaries are enforced server-side.</done>
</task>

<task type="auto">
  <name>Task 3: Add gifts router procedures and wire website snapshot integration</name>
  <files>packages/api/src/routers/gifts.ts, packages/api/src/routers/website.ts, packages/api/src/routers/index.ts</files>
  <action>Create gifts router procedures for admin draft CRUD/publish/hide/disable, guest invite-only view, and contribution submit. Register `gifts` in app router and expose gift payload inside website snapshot response so website routes can show tab/CTA data and unavailable state without bypassing invite checks.</action>
  <verify>`packages/api` typecheck succeeds and web client receives typed gifts data in both dashboard and website flows.</verify>
  <done>Phase-06 backend API contract is complete and consumable by web plans.</done>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds.
- [ ] Publish mutation rejects empty pre-publish note with explicit validation error.
- [ ] Hide/disable actions are rejected for non-admin/non-coordinator memberships with explicit forbidden responses.
- [ ] Contribution mutation rejects unavailable states (`draft|hidden|disabled`) and updates raised amount atomically when published.
- [ ] Website snapshot contract includes invite-only gifts payload with contributor identity redacted.
</verification>

<success_criteria>
- All tasks completed.
- GFT-01 backend behavior (publishable gifts details for invited guests) is available.
- GFT-02 backend safeguards (role restrictions + hide/disable + audit) are enforced.
</success_criteria>

<output>
After completion, create `.gsd/phases/06-gifts-basics-and-safety-controls/06-02-SUMMARY.md`.
</output>
