---
phase: 06-gifts-basics-and-safety-controls
plan: "04"
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - apps/web/src/routes/site.$weddingSlug.tsx
  - apps/web/src/components/website/gifts-nav-tab.tsx
  - apps/web/src/components/website/gifts-sticky-cta.tsx
  - apps/web/src/components/website/gifts-panel.tsx
  - apps/web/src/components/website/gifts-unavailable-banner.tsx
autonomous: false
user_setup: []
must_haves:
  truths:
    - "Invite-only wedding website surfaces gifts through a navigation tab and sticky CTA for verified guests only."
    - "Guest-facing gifts view shows wishlist progress as both amount raised and percent, while hiding contributor identities."
    - "When gifts are hidden/disabled, guests receive graceful unavailable messaging and cannot submit new contributions."
  artifacts:
    - path: apps/web/src/routes/site.$weddingSlug.tsx
      provides: Website route integration for gifts tab/CTA, invite-only conditional rendering, and contribution mutation wiring
      min_lines: 220
      contains: createFileRoute("/site/$weddingSlug")
    - path: apps/web/src/components/website/gifts-panel.tsx
      provides: Guest gifts list with UPI details, wishlist progress, completion badges, and contribution input actions
      min_lines: 180
      contains: export function GiftsPanel
    - path: apps/web/src/components/website/gifts-unavailable-banner.tsx
      provides: Graceful unavailable state copy and action-blocking UI for hidden/disabled modes
      min_lines: 60
      contains: export function GiftsUnavailableBanner
    - path: apps/web/src/components/website/gifts-sticky-cta.tsx
      provides: Sticky CTA entrypoint for gifts mode that respects invite-only and unavailable states
      min_lines: 70
      contains: export function GiftsStickyCta
  key_links:
    - from: apps/web/src/routes/site.$weddingSlug.tsx
      to: packages/api/src/routers/website.ts
      via: Website snapshot response provides invite-only gifts payload and mode availability state
    - from: apps/web/src/components/website/gifts-panel.tsx
      to: packages/api/src/routers/gifts.ts
      via: Contribution submissions and refreshed progress counts are served by gifts API
---

<objective>
Deliver the guest-facing website gifts experience with locked invite-only visibility and unavailable-state safeguards.

Purpose: Make GFT-01 usable by invited guests while preserving the safety semantics defined for hide/disable behavior.
Output: Website gifts tab + sticky CTA + gift contribution panel with progress/completed states and graceful unavailable messaging.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@~/.kilocode/rules/checkpoints.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/phases/06-gifts-basics-and-safety-controls/06-CONTEXT.md
@.gsd/phases/06-gifts-basics-and-safety-controls/06-02-PLAN.md
@apps/web/src/routes/site.$weddingSlug.tsx
@apps/web/src/components/website/rsvp-sticky-cta.tsx
@apps/web/src/components/website/stale-sync-banner.tsx
@packages/api/src/routers/website.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Integrate gifts navigation/tab state into website route</name>
  <files>apps/web/src/routes/site.$weddingSlug.tsx, apps/web/src/components/website/gifts-nav-tab.tsx</files>
  <action>Extend website route to consume gifts snapshot payload, render a gifts tab for verified invited guests, and hide gifts surfaces for non-invited/non-verified visitors. Keep existing RSVP flows intact while adding deterministic gifts-section routing within the page.</action>
  <verify>Non-verified visitors do not see gifts entrypoints; verified invited guests do.</verify>
  <done>Invite-only visibility boundary is enforced in guest UI surfaces.</done>
</task>

<task type="auto">
  <name>Task 2: Build gifts panel with progress/completion and contribution actions</name>
  <files>apps/web/src/components/website/gifts-panel.tsx, apps/web/src/routes/site.$weddingSlug.tsx</files>
  <action>Render UPI details + wishlist items with amount raised and percent progress, show completed badges while keeping completed items visible, and wire contribution submission mutations with optimistic-disabled submit state and post-success refetch.</action>
  <verify>Guest panel displays progress math from server response and never renders contributor identity fields.</verify>
  <done>Invited guests can view and contribute toward wishlist targets from the website.</done>
</task>

<task type="auto">
  <name>Task 3: Add sticky CTA and graceful unavailable handling</name>
  <files>apps/web/src/components/website/gifts-sticky-cta.tsx, apps/web/src/components/website/gifts-unavailable-banner.tsx, apps/web/src/routes/site.$weddingSlug.tsx</files>
  <action>Implement gifts sticky CTA and unavailable banner states for hidden/disabled modes. Ensure UI blocks contribution interactions and shows clear unavailable message when mode state changes while user is on page (via query invalidation/refetch).</action>
  <verify>When gifts mode transitions to hidden/disabled, panel switches to unavailable state and submit actions are blocked.</verify>
  <done>Website behavior stays safe and understandable during operator safety-control transitions.</done>
</task>

<task type="auto">
  <name>Task 4: Resolve deterministic wedding slug and website URL for verification</name>
  <files>None (runtime verification setup)</files>
  <action>Resolve a concrete wedding slug from seeded fixture/API data (for example, query the website snapshot source for the target wedding) and persist it for downstream tasks at `.gsd/tmp/06-04-wedding-slug.txt`. Build and persist the concrete URL `http://localhost:3000/site/$WEDDING_SLUG` at `.gsd/tmp/06-04-site-url.txt` for checkpoint use.</action>
  <verify>Resolved slug is non-empty and the persisted URL file contains a concrete local route with no placeholder token.</verify>
  <done>All verification steps can reference one deterministic local website URL.</done>
</task>

<task type="auto">
  <name>Task 5: Start and verify web dev server for website checkpoint</name>
  <files>None (runtime verification setup)</files>
  <action>Start the web dev server in background (for example, `bun run --filter web dev`) and confirm the concrete URL stored in `.gsd/tmp/06-04-site-url.txt` is reachable before human verification.</action>
  <verify>`curl $(cat .gsd/tmp/06-04-site-url.txt)` returns HTTP 200 (or framework redirect response that resolves to the route).</verify>
  <done>Checkpoint runs against an explicitly available local URL.</done>
</task>

<task type="auto">
  <name>Task 6: Prepare invited and verified guest session context</name>
  <files>None (runtime verification setup)</files>
  <action>Provision a verified invited guest session for the resolved wedding and persist reusable session state (for example, cookie jar/storage state) at `.gsd/tmp/06-04-invited-verified.session` so gifts tab/CTA behavior can be verified on the concrete site URL.</action>
  <verify>Loading the concrete site URL with this prepared context surfaces gifts tab + sticky CTA.</verify>
  <done>Checkpoint has a ready invited/verified context for positive-path validation.</done>
</task>

<task type="auto">
  <name>Task 7: Prepare non-invited or non-verified session context</name>
  <files>None (runtime verification setup)</files>
  <action>Provision a session context representing non-invited or non-verified access and persist it at `.gsd/tmp/06-04-non-invited.session` for negative-path verification on the same concrete site URL.</action>
  <verify>Loading the concrete site URL with this context does not expose gifts tab/CTA or contribution interactions.</verify>
  <done>Checkpoint has a ready negative-path context for invite-only enforcement validation.</done>
</task>

<task type="auto">
  <name>Task 8: Prepare operator toggle path for active guest-page hide/disable checks</name>
  <files>None (runtime verification setup)</files>
  <action>Prepare an operator (admin/coordinator) session context for `http://localhost:3000/dashboard/gifts` and keep it ready to run hide/disable toggles while the invited guest session is open on the concrete site URL, so live unavailable-state transition behavior can be validated during checkpoint.</action>
  <verify>Operator context can reach dashboard gifts controls and trigger hide/disable actions against the same wedding used in the guest URL.</verify>
  <done>Checkpoint can validate live guest-page safety-state transitions without additional manual setup.</done>
</task>

<task type="auto">
  <name>Task 9: Generate deterministic website-gifts verification runbook</name>
  <files>.gsd/tmp/06-04-website-gifts-runbook.md</files>
  <action>Create `.gsd/tmp/06-04-website-gifts-runbook.md` that defines exact context-to-window mapping and expected outcomes using concrete URLs: guest URL from `.gsd/tmp/06-04-site-url.txt` and operator URL `http://localhost:3000/dashboard/gifts`. Include explicit browser mapping (`Window A = invited/verified`, `Window B = non-invited/non-verified`, `Window C = operator toggle`), session artifact mapping from Tasks 6-8, and numbered verification steps for visibility gating, progress/completion rendering, identity privacy, and live hide/disable unavailable transition behavior.</action>
  <verify>Runbook exists and contains concrete URLs, deterministic window/session mapping, and per-step expected outcomes for all three contexts.</verify>
  <done>Human checkpoint has an unambiguous invited/non-invited/operator verification procedure.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Invite-only website gifts experience with tab, sticky CTA, progress view, contributions, and unavailable-state handling</what-built>
  <how-to-verify>
    Use `.gsd/tmp/06-04-website-gifts-runbook.md` and execute its numbered steps:
    1. Runbook Step 1 (Window A invited/verified visibility baseline).
    2. Runbook Step 2 (Window B non-invited/non-verified gating on the same URL).
    3. Runbook Step 3 (Window A progress/completion rendering and contributor-identity privacy checks).
    4. Runbook Step 4 (Window C operator hide/disable toggle and Window A live unavailable transition with contribution blocking).
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p apps/web/tsconfig.json` succeeds.
- [ ] `bun run --filter web build` succeeds.
- [ ] Guest website gifts surfaces are gated by invite verification state.
- [ ] Human checkpoint confirms tab/CTA visibility, progress/completion rendering, and unavailable-state behavior.
</verification>

<success_criteria>
- All tasks completed.
- Invite-only guest gifts experience is usable and aligned with locked context semantics.
- Hide/disable safety behavior is reflected clearly on active guest pages.
</success_criteria>

<output>
After completion, create `.gsd/phases/06-gifts-basics-and-safety-controls/06-04-SUMMARY.md`.
</output>
