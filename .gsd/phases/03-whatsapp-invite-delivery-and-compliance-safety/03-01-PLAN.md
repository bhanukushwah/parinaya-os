---
phase: 03-whatsapp-invite-delivery-and-compliance-safety
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/whatsapp.ts
  - packages/db/src/schema/index.ts
  - packages/env/src/server.ts
  - packages/db/src/migrations/*.sql
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Outbound invite operations are first-class persisted entities with run-level and message-level records."
    - "Lifecycle and webhook ingestion data is stored in a way that supports monotonic status projection and idempotency checks."
    - "Do-Not-Message and send eligibility data primitives exist before dispatch logic is implemented."
  artifacts:
    - path: packages/db/src/schema/whatsapp.ts
      provides: Invite run, invite message, webhook event, and DNM schema primitives
      min_lines: 180
      contains: export const inviteMessages
    - path: packages/db/src/schema/index.ts
      provides: Schema barrel export for whatsapp module
      contains: export * from "./whatsapp"
    - path: packages/env/src/server.ts
      provides: Runtime env validation for WhatsApp Cloud API and webhook verification settings
      contains: WHATSAPP_API_BASE_URL
    - path: packages/db/src/migrations
      provides: SQL migration artifacts for phase-03 schema additions
  key_links:
    - from: packages/db/src/schema/whatsapp.ts
      to: packages/db/src/schema/guests.ts
      via: invite recipient targets linked to deterministic guest/audience entities
    - from: packages/db/src/schema/whatsapp.ts
      to: packages/db/src/schema/governance.ts
      via: send actor/auditability references for governance compliance
---

<objective>
Create the Phase 03 data and runtime configuration foundation for WhatsApp invite delivery and lifecycle tracking.

Purpose: Encode WA-01/WA-02/WA-04 invariants in schema and env contracts before API execution paths are added.
Output: New schema module, env keys, and generated migration SQL for invite runs, messages, webhook events, and compliance controls.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/STATE.md
@.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-CONTEXT.md
@.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-RESEARCH.md
@packages/db/src/schema/guests.ts
@packages/db/src/schema/governance.ts
@packages/env/src/server.ts
@packages/db/drizzle.config.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add whatsapp-domain schema primitives</name>
  <files>packages/db/src/schema/whatsapp.ts</files>
  <action>Create enums and tables for send runs, per-recipient invite messages, webhook receipts, lifecycle transition logs, and DNM controls. Include provider message id correlation fields, rejection reason fields, and indexes supporting event/run/message queries.</action>
  <verify>Schema compiles and Drizzle types infer relations/columns without errors.</verify>
  <done>Database can persist outbound invite lifecycle and compliance outcomes with no placeholder entities.</done>
</task>

<task type="auto">
  <name>Task 2: Extend runtime env contract for provider and webhook config</name>
  <files>packages/env/src/server.ts</files>
  <action>Add validated environment variables needed for Meta Cloud API and webhook verification (base URL, access token, phone-number-id, verify token/app secret). Keep schema strict and compatible with existing env validation pattern.</action>
  <verify>TypeScript compile for env package succeeds and server env object exposes new keys.</verify>
  <done>Provider and webhook settings are validated at runtime startup.</done>
</task>

<task type="auto">
  <name>Task 3: Export schema and generate migration SQL</name>
  <files>packages/db/src/schema/index.ts, packages/db/src/migrations/*.sql</files>
  <action>Wire whatsapp schema into barrel exports and run `bun run db:generate` to emit migration artifacts. Ensure lifecycle/idempotency indexes and constraints are represented in generated SQL.</action>
  <verify>`bun run db:generate` succeeds and migration files are created for whatsapp-domain tables.</verify>
  <done>Phase-03 data foundation is migration-backed and ready for API implementation.</done>
</task>
</tasks>

<verification>
- [ ] `bun run db:generate` succeeds and creates migration SQL for whatsapp-domain entities.
- [ ] `bunx tsc --noEmit -p packages/db/tsconfig.json` succeeds.
- [ ] `bunx tsc --noEmit -p packages/env/tsconfig.json` succeeds.
- [ ] Schema includes correlation and lifecycle fields required for webhook-driven status tracking.
</verification>

<success_criteria>
- All tasks completed.
- Schema/runtime primitives enforce phase-03 delivery/compliance baseline.
- Migrations are generated and consumable by downstream API plans.
</success_criteria>

<output>
After completion, create `.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-01-SUMMARY.md`.
</output>
