---
phase: 03-whatsapp-invite-delivery-and-compliance-safety
plan: "02"
type: execute
wave: 1
depends_on: ["03-01"]
files_modified:
  - packages/api/src/services/whatsapp-policy.ts
  - packages/api/src/services/whatsapp-provider.ts
  - packages/api/src/services/whatsapp-dispatch.ts
  - packages/api/src/routers/invites.ts
  - packages/api/src/routers/index.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Invite sends are initiated through one server-owned dispatch path that reuses audience recipient resolution from Phase 2."
    - "Do-Not-Message and send-eligibility checks execute before provider dispatch and persist per-recipient rejection reasons."
    - "Invite send action writes invite-send audit events and stores provider correlation ids for successful dispatches."
  artifacts:
    - path: packages/api/src/services/whatsapp-dispatch.ts
      provides: Run orchestration from audience resolution through policy filtering and provider send
      min_lines: 180
      contains: export async function dispatchInviteRun
    - path: packages/api/src/services/whatsapp-policy.ts
      provides: Compliance/eligibility gate logic for outbound recipients
      min_lines: 80
      contains: evaluateSendEligibility
    - path: packages/api/src/services/whatsapp-provider.ts
      provides: Meta Cloud API template send adapter and response normalization
      min_lines: 120
      contains: sendTemplateInvite
    - path: packages/api/src/routers/invites.ts
      provides: Protected invite send/precheck/list procedures for operators
      min_lines: 150
      contains: export const invitesRouter
  key_links:
    - from: packages/api/src/services/whatsapp-dispatch.ts
      to: packages/api/src/services/audience-builder.ts
      via: Send run candidate resolution reuses shared audience recipient path
      pattern: buildAudience
    - from: packages/api/src/services/whatsapp-dispatch.ts
      to: packages/api/src/services/whatsapp-policy.ts
      via: Recipient dispatch filtered by policy gate before provider calls
    - from: packages/api/src/routers/invites.ts
      to: packages/api/src/services/whatsapp-dispatch.ts
      via: Router delegates send orchestration and returns persisted run summary
---

<objective>
Implement the outbound invite send pipeline with compliance gating and provider dispatch integration.

Purpose: Deliver WA-01 and WA-04 behavior through a deterministic, auditable server flow.
Output: Invite router + services that can create send runs, block non-compliant recipients, dispatch eligible template messages, and persist outcomes.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-01-PLAN.md
@.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-CONTEXT.md
@.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-RESEARCH.md
@packages/api/src/services/audience-builder.ts
@packages/api/src/services/audit-log.ts
@packages/api/src/policies/authorize.ts
@packages/api/src/routers/index.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Build send eligibility and DNM policy service</name>
  <files>packages/api/src/services/whatsapp-policy.ts</files>
  <action>Create policy evaluation service that checks DNM rules, inviteability constraints, and missing-provider-data conditions. Return structured allow/block outcomes with machine-readable rejection reasons for persistence and operator summaries.</action>
  <verify>Service compiles and returns deterministic outcomes for equivalent input sets.</verify>
  <done>Compliance gate behavior is centralized and reusable by dispatch paths.</done>
</task>

<task type="auto">
  <name>Task 2: Build provider adapter and dispatch orchestration</name>
  <files>packages/api/src/services/whatsapp-provider.ts, packages/api/src/services/whatsapp-dispatch.ts</files>
  <action>Implement provider adapter for template sends and dispatch service that creates send run records, resolves recipients via shared audience path, applies policy gate, sends eligible recipients, persists provider ids/errors, and emits `invite.send` audit entries.</action>
  <verify>`bunx tsc --noEmit -p packages/api/tsconfig.json` passes and dispatch path persists both blocked and dispatched outcomes.</verify>
  <done>Server can execute compliant outbound invite runs with persisted operational telemetry.</done>
</task>

<task type="auto">
  <name>Task 3: Expose invite send procedures in app router</name>
  <files>packages/api/src/routers/invites.ts, packages/api/src/routers/index.ts</files>
  <action>Add protected procedures for starting invite send runs and reading run/message outcomes. Enforce Parent Admin-only send mutation and stable response contract for dashboard usage.</action>
  <verify>Router compiles and app router exports `invites` domain for typed clients.</verify>
  <done>Invite send capability is callable through typed RPC with role and compliance enforcement.</done>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds.
- [ ] Parent Admin can trigger invite send run through `invites` router mutation.
- [ ] Blocked recipients are persisted with explicit rejection reasons before dispatch.
- [ ] Successful provider dispatch persists provider message correlation identifiers.
</verification>

<success_criteria>
- All tasks completed.
- WA-01 outbound send path exists and is role/policy enforced.
- WA-04 pre-send compliance blocks are persisted and visible.
</success_criteria>

<output>
After completion, create `.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-02-SUMMARY.md`.
</output>
