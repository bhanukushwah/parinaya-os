---
phase: 03-whatsapp-invite-delivery-and-compliance-safety
plan: "05"
type: execute
wave: 2
depends_on: ["03-01", "03-02", "03-03", "03-04"]
files_modified:
  - packages/api/src/services/whatsapp-lifecycle.test.ts
  - packages/api/src/services/whatsapp-policy.test.ts
  - .gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-VERIFICATION.md
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Lifecycle transitions are test-proven monotonic under duplicate and out-of-order webhook events."
    - "Compliance policy blocking logic is test-proven for Do-Not-Message and non-inviteable recipients."
    - "Phase-level verification artifact explicitly validates WA-01/WA-02/WA-04 success criteria with evidence references."
  artifacts:
    - path: packages/api/src/services/whatsapp-lifecycle.test.ts
      provides: Automated tests for lifecycle progression/idempotency/regression guards
      min_lines: 90
      contains: describe("whatsapp lifecycle")
    - path: packages/api/src/services/whatsapp-policy.test.ts
      provides: Automated tests for DNM and eligibility rejection behavior
      min_lines: 80
      contains: describe("whatsapp policy")
    - path: .gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-VERIFICATION.md
      provides: Phase verification report with must-have artifact/wiring checks and human verification outcomes
      min_lines: 120
      contains: ## Verdict
  key_links:
    - from: packages/api/src/services/whatsapp-lifecycle.test.ts
      to: packages/api/src/services/whatsapp-lifecycle.ts
      via: Tests enforce monotonic transition behavior and replay handling
    - from: packages/api/src/services/whatsapp-policy.test.ts
      to: packages/api/src/services/whatsapp-policy.ts
      via: Tests enforce blocking criteria and structured rejection reasons
---

<objective>
Complete quality hardening and formal verification for Phase 03 outcomes.

Purpose: Prove that invite delivery, lifecycle tracking, and compliance blocking are implemented behaviorally (not just by file existence).
Output: Automated policy/lifecycle tests plus a full phase verification report.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@~/.kilocode/rules/verification-patterns.md
@.gsd/templates/verification-report.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-02-PLAN.md
@.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-03-PLAN.md
@.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-04-PLAN.md
@packages/api/src/services/whatsapp-policy.ts
@packages/api/src/services/whatsapp-lifecycle.ts
@packages/api/src/routers/invites.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add lifecycle monotonicity and idempotency tests</name>
  <files>packages/api/src/services/whatsapp-lifecycle.test.ts</files>
  <action>Add focused tests for valid forward transitions, blocked regressions, duplicate event replay, and failed-state handling. Cover out-of-order webhook scenarios explicitly.</action>
  <verify>Targeted test command passes and fails when transition guards are intentionally broken.</verify>
  <done>Lifecycle state machine behavior is regression-protected by automated tests.</done>
</task>

<task type="auto">
  <name>Task 2: Add policy gate compliance tests</name>
  <files>packages/api/src/services/whatsapp-policy.test.ts</files>
  <action>Add tests covering DNM blocks, non-inviteable blocks, and eligible pass-through behavior with stable rejection reason outputs.</action>
  <verify>Targeted test command passes with deterministic policy outcomes.</verify>
  <done>WA-04 policy behavior is regression-protected by automated tests.</done>
</task>

<task type="auto">
  <name>Task 3: Produce phase verification report</name>
  <files>.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-VERIFICATION.md</files>
  <action>Run artifact/wiring/substance checks and summarize evidence for WA-01, WA-02, WA-04 plus operator UI checkpoint results. Call out any unresolved risks with explicit severity and mitigation.</action>
  <verify>Verification report includes pass/fail verdict and references concrete files/commands for each must-have.</verify>
  <done>Phase 03 completion evidence is explicit and actionable.</done>
</task>
</tasks>

<verification>
- [ ] Targeted lifecycle tests pass.
- [ ] Targeted policy tests pass.
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds.
- [ ] `03-VERIFICATION.md` declares a clear verdict for WA-01/WA-02/WA-04.
</verification>

<success_criteria>
- All tasks completed.
- Automated tests protect lifecycle and compliance invariants.
- Phase verification artifact is complete and decision-ready.
</success_criteria>

<output>
After completion, create `.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-05-SUMMARY.md`.
</output>
