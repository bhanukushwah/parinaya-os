---
phase: 03-whatsapp-invite-delivery-and-compliance-safety
plan: "03"
type: execute
wave: 1
depends_on: ["03-01", "03-02"]
files_modified:
  - apps/server/src/index.ts
  - packages/api/src/services/whatsapp-webhook.ts
  - packages/api/src/services/whatsapp-lifecycle.ts
  - packages/api/src/routers/invites.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Webhook events are authenticated before lifecycle mutations occur."
    - "Per-message lifecycle states progress monotonically across `sent`, `delivered`, `read`, and `failed`."
    - "Duplicate or out-of-order webhook deliveries are handled idempotently without regressing final status."
  artifacts:
    - path: packages/api/src/services/whatsapp-webhook.ts
      provides: Webhook payload validation, normalization, and persistence entrypoint
      min_lines: 140
      contains: processWhatsAppWebhook
    - path: packages/api/src/services/whatsapp-lifecycle.ts
      provides: Monotonic lifecycle state transition gate and update writer
      min_lines: 100
      contains: applyLifecycleTransition
    - path: apps/server/src/index.ts
      provides: HTTP webhook endpoint wiring for Meta callback verification and event ingestion
      contains: /webhooks/whatsapp
  key_links:
    - from: apps/server/src/index.ts
      to: packages/api/src/services/whatsapp-webhook.ts
      via: Incoming webhook HTTP requests delegated to service-level ingestion handler
    - from: packages/api/src/services/whatsapp-webhook.ts
      to: packages/api/src/services/whatsapp-lifecycle.ts
      via: Normalized status events pass through monotonic transition gate before persistence
---

<objective>
Implement webhook ingestion and monotonic lifecycle transition handling for outbound invite messages.

Purpose: Deliver WA-02 lifecycle reliability using authenticated, idempotent server ingestion.
Output: Webhook route + services that verify payloads, correlate provider message ids, and update message status safely.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-01-PLAN.md
@.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-02-PLAN.md
@.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-CONTEXT.md
@packages/api/src/services/whatsapp-dispatch.ts
@apps/server/src/index.ts
@packages/env/src/server.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add webhook normalization and authenticity verification service</name>
  <files>packages/api/src/services/whatsapp-webhook.ts</files>
  <action>Implement webhook callback verification and event payload normalization for status updates. Persist raw receipt metadata and skip invalid/untrusted payloads from mutation paths.</action>
  <verify>Service compiles and returns normalized events only for authenticated payloads.</verify>
  <done>Webhook ingestion entrypoint is secure and deterministic.</done>
</task>

<task type="auto">
  <name>Task 2: Add monotonic lifecycle transition service</name>
  <files>packages/api/src/services/whatsapp-lifecycle.ts</files>
  <action>Create explicit transition-rank logic for `sent`, `delivered`, `read`, and `failed` states. Apply idempotent updates per provider message id and persist transition records for observability.</action>
  <verify>`bunx tsc --noEmit -p packages/api/tsconfig.json` passes and transition gate blocks state regression.</verify>
  <done>Lifecycle updates are monotonic and replay-safe under duplicate/out-of-order webhooks.</done>
</task>

<task type="auto">
  <name>Task 3: Wire webhook endpoint into server host and expose lifecycle reads</name>
  <files>apps/server/src/index.ts, packages/api/src/routers/invites.ts</files>
  <action>Add `/webhooks/whatsapp` endpoint wiring for verification/event callbacks and extend invite query procedures to surface lifecycle status for operator consumption.</action>
  <verify>Server starts with webhook route and API typecheck passes for lifecycle query contract.</verify>
  <done>Webhook updates flow into persisted per-message lifecycle state visible through API.</done>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds.
- [ ] Webhook endpoint rejects unauthenticated payloads.
- [ ] Replayed webhook for same message/status does not duplicate transition.
- [ ] Out-of-order status payload cannot regress message state.
</verification>

<success_criteria>
- All tasks completed.
- WA-02 lifecycle tracking is backed by authenticated, monotonic webhook ingestion.
- Operator-facing lifecycle reads are available through typed API.
</success_criteria>

<output>
After completion, create `.gsd/phases/03-whatsapp-invite-delivery-and-compliance-safety/03-03-SUMMARY.md`.
</output>
