---
phase: 01-multi-event-foundation-governance-controls
plan: "03"
type: execute
wave: 3
depends_on:
  - "01-01"
  - "01-02"
files_modified:
  - packages/api/src/routers/governance.ts
  - packages/api/src/routers/audit.ts
  - packages/api/src/routers/index.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Owner/Admin role-change boundaries are server-enforced for workspace collaborators."
    - "Role changes support optional reason notes and always produce audit records with before/after summary."
    - "A central audit query surface exists and coordinators can read routine operational logs such as invite-send and guest-edit events."
  artifacts:
    - path: packages/api/src/routers/governance.ts
      provides: Membership role-management procedures with boundary checks
      min_lines: 100
      contains: export const governanceRouter
    - path: packages/api/src/routers/audit.ts
      provides: Central audit list/detail query procedures with role-aware visibility filtering
      min_lines: 80
      contains: export const auditRouter
    - path: packages/api/src/routers/index.ts
      provides: App router composition exposing governance/audit/event domains
      contains: "governance:"
  key_links:
    - from: packages/api/src/routers/governance.ts
      to: packages/api/src/policies/authorize.ts
      via: role-change permission enforcement
      pattern: assertRoleChangeAllowed\(
    - from: packages/api/src/routers/governance.ts
      to: packages/api/src/services/audit-log.ts
      via: role-change audit write
      pattern: writeAuditLog\(
    - from: packages/api/src/routers/audit.ts
      to: packages/db/src/schema/governance.ts
      via: audit log query filtering
---

<objective>
Implement governance and audit API surfaces and wire them into the app router.

Purpose: Deliver GOV-01 and GOV-02 backend contracts for role control and centralized audit retrieval.
Output: Governance router, audit router, and app router composition with new domains enabled.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/phases/01-multi-event-foundation-governance-controls/01-CONTEXT.md
@.gsd/phases/01-multi-event-foundation-governance-controls/01-RESEARCH.md
@.gsd/phases/01-multi-event-foundation-governance-controls/01-02-SUMMARY.md
@packages/api/src/index.ts
@packages/api/src/routers/index.ts
@packages/api/src/policies/authorize.ts
@packages/api/src/services/audit-log.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Implement governance router for role membership operations</name>
  <files>packages/api/src/routers/governance.ts</files>
  <action>Create procedures to list memberships and change collaborator roles within owner/admin/coordinator boundaries from locked decisions. Enforce owner top-level control context, allow admin-level coordinator management, and reject unauthorized changes with generic forbidden errors only. Persist optional reason notes and capture before/after role summary in audit entries.</action>
  <verify>`bun run check-types` passes and governance router exports typed procedures.</verify>
  <done>Role assignment boundaries are server-enforced and audited with optional reason metadata.</done>
</task>

<task type="auto">
  <name>Task 2: Implement central audit query router with coordinator-safe visibility</name>
  <files>packages/api/src/routers/audit.ts</files>
  <action>Build audit listing procedures for central audit page consumption, with filters for action type/date window/actor/target. Include response fields for actor, time, action, beforeSummary, afterSummary, optional reason. Add role-aware visibility so coordinators can read routine operational logs (including `invite.send` and `guest.edit`) while protected governance-only entries remain restricted per policy decisions.</action>
  <verify>Audit router compiles and returns typed rows containing before/after summary fields.</verify>
  <done>Central audit API exists with role-aware read behavior aligned to phase context.</done>
</task>

<task type="auto">
  <name>Task 3: Compose routers into appRouter and keep health/private routes working</name>
  <files>packages/api/src/routers/index.ts</files>
  <action>Integrate `eventsRouter`, `governanceRouter`, and `auditRouter` into the exported `appRouter` while preserving existing `healthCheck` and `privateData`. Ensure router naming is stable for frontend query utility usage and that type exports continue to compile for `AppRouterClient` consumers.</action>
  <verify>`bun run check-types` succeeds in both `packages/api` and `apps/web` consumers of router types.</verify>
  <done>All phase-01 API domains are reachable through composed app router without regressions.</done>
</task>
</tasks>

<verification>
- [ ] `bun run check-types` passes after governance/audit router additions and app router composition.
- [ ] Role-change procedure writes audit entries with before/after role summary and optional reason.
- [ ] Audit query route returns actor/timestamp/action/before/after fields and supports filtering.
- [ ] Coordinator-safe routine log visibility includes invite-send and guest-edit action categories.
</verification>

<success_criteria>
- All tasks completed.
- GOV-01 and GOV-02 server contracts are available from composed API router.
- Role boundaries and audit accessibility match locked discuss-phase outcomes.
</success_criteria>

<output>
After completion, create `.gsd/phases/01-multi-event-foundation-governance-controls/01-03-SUMMARY.md`.
</output>
