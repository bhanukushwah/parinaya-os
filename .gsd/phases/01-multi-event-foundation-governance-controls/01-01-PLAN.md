---
phase: 01-multi-event-foundation-governance-controls
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/events.ts
  - packages/db/src/schema/governance.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/migrations/*.sql
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Event data supports lifecycle fields for draft/published/archive and global ordering."
    - "Event visibility state is persistable as public or invite-only with grant-based eligibility records."
    - "Role memberships and audit entries are first-class persisted entities for governance actions."
  artifacts:
    - path: packages/db/src/schema/events.ts
      provides: Event tables, enums, and visibility grant schema
      min_lines: 80
      contains: export const weddingEvents
    - path: packages/db/src/schema/governance.ts
      provides: Membership roles and append-only audit log schema
      min_lines: 70
      contains: export const auditLogs
    - path: packages/db/src/schema/index.ts
      provides: Schema barrel exports for events and governance modules
      contains: export * from "./events"
    - path: packages/db/src/migrations
      provides: SQL migration files for new phase-01 tables
  key_links:
    - from: packages/db/src/index.ts
      to: packages/db/src/schema/index.ts
      via: drizzle schema import
      pattern: import \* as schema from "./schema"
    - from: packages/db/src/schema/events.ts
      to: packages/db/src/schema/governance.ts
      via: foreign keys between event and membership/audit entities
---

<objective>
Create Phase 1 data foundation for multi-event lifecycle and governance controls.

Purpose: Ensure EVT-01/EVT-02/GOV-01/GOV-02 can be implemented with durable schema primitives instead of ad-hoc fields.
Output: New Drizzle schema modules and generated SQL migration for events, visibility eligibility, memberships, and audits.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/PROJECT.md
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/STATE.md
@.gsd/phases/01-multi-event-foundation-governance-controls/01-CONTEXT.md
@.gsd/phases/01-multi-event-foundation-governance-controls/01-RESEARCH.md
@packages/db/src/schema/auth.ts
@packages/db/drizzle.config.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add event lifecycle and visibility schema primitives</name>
  <files>packages/db/src/schema/events.ts</files>
  <action>Create `weddingEvents` with status, visibility, sort order, archivedAt, createdAt, updatedAt, and defaults (`draft`, `invite-only`). Add supporting enums and `eventVisibilityGrants` to represent invite-only eligibility bindings (principal type + principal id) so login-then-eligibility enforcement has a concrete persisted source. Use indexes for workspace ordering and visibility-filtered reads.</action>
  <verify>Type check for schema file succeeds via `bun run check-types`.</verify>
  <done>Event lifecycle, visibility mode, soft archive, and eligibility grant persistence are all modeled in Drizzle schema.</done>
</task>

<task type="auto">
  <name>Task 2: Add governance role membership and audit schema</name>
  <files>packages/db/src/schema/governance.ts</files>
  <action>Create `weddingMemberships` with owner/admin/coordinator roles and uniqueness per user+wedding workspace. Create append-only `auditLogs` table containing actor, action type, target, before/after summary, optional reason note, and timestamp. Add index strategy to support central audit listing and 12-month retention pruning jobs.</action>
  <verify>Schema compiles and Drizzle types infer without errors in `bun run check-types`.</verify>
  <done>Governance role data and audit trail storage contracts are available for API implementation.</done>
</task>

<task type="auto">
  <name>Task 3: Export schema and generate migration SQL</name>
  <files>packages/db/src/schema/index.ts, packages/db/src/migrations/*.sql</files>
  <action>Update schema barrel exports to include `events` and `governance` modules. Run `bun run db:generate` to produce migration SQL in `packages/db/src/migrations` for all new entities and indexes. Ensure generated SQL is deterministic and captures enum/table/index creation for phase-01 schema changes.</action>
  <verify>`bun run db:generate` completes and new migration files exist under `packages/db/src/migrations`.</verify>
  <done>Database schema changes are export-wired and migration artifacts are ready for execution environments.</done>
</task>
</tasks>

<verification>
- [ ] `bun run db:generate` succeeds and creates migration SQL for phase-01 tables.
- [ ] `bun run check-types` succeeds across workspace.
- [ ] Generated schema includes defaults for new events (`draft`, `invite-only`) and nullable `archivedAt` for soft restore.
</verification>

<success_criteria>
- All tasks completed.
- Event, eligibility, membership, and audit entities exist with real schema definitions (not placeholders).
- Migration SQL is generated and matches schema intent for Phase 1 requirements.
</success_criteria>

<output>
After completion, create `.gsd/phases/01-multi-event-foundation-governance-controls/01-01-SUMMARY.md`.
</output>
