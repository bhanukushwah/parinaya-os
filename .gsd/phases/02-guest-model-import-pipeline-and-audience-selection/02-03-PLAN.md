---
phase: 02-guest-model-import-pipeline-and-audience-selection
plan: "03"
type: execute
wave: 3
depends_on:
  - "02-01"
  - "02-02"
files_modified:
  - packages/api/package.json
  - packages/api/src/services/guest-import.ts
  - packages/api/src/services/guest-import-csv.ts
  - packages/api/src/services/guest-import-contacts.ts
  - packages/api/src/routers/guest-imports.ts
  - packages/api/src/routers/index.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Import supports CSV, contacts, and manual row entry through one deterministic pipeline."
    - "Malformed phone rows are persisted with warning state and marked not inviteable."
    - "Minimum required field for active invite target is phone."
    - "Dedupe scope is workspace-wide and reuses phone-only identity service behavior."
  artifacts:
    - path: packages/api/package.json
      provides: Import dependencies for CSV parsing and phone normalization
      contains: csv-parse
    - path: packages/api/src/services/guest-import.ts
      provides: Shared ingest-normalize-resolve-persist pipeline for all channels
      min_lines: 180
      contains: export async function runGuestImport
    - path: packages/api/src/services/guest-import-csv.ts
      provides: CSV ingestion adapter using csv-parse stream processing
      min_lines: 70
      contains: parse
    - path: packages/api/src/routers/guest-imports.ts
      provides: Import run procedures for CSV upload, contacts payloads, and manual row commits
      min_lines: 140
      contains: export const guestImportsRouter
  key_links:
    - from: packages/api/src/routers/guest-imports.ts
      to: packages/api/src/services/guest-import.ts
      via: channel-specific routes call shared deterministic import pipeline
      pattern: runGuestImport\(
    - from: packages/api/src/services/guest-import.ts
      to: packages/api/src/services/guest-identity.ts
      via: row-level dedupe/reactivation via normalized phone identity upsert
      pattern: upsertGuestIdentity\(
    - from: packages/api/src/services/guest-import.ts
      to: packages/api/src/services/audit-log.ts
      via: import-run and guest-edit audit emission
      pattern: writeAuditLog\(
---

<objective>
Deliver channel-agnostic import execution with deterministic dedupe and warning-preserving persistence.

Purpose: Implement GST-02 and the import-specific portions of GST-03 without allowing source-specific behavior drift.
Output: Guest import services and API routes for CSV, contacts, and manual rows using one shared resolve/persist path.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-CONTEXT.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-RESEARCH.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-01-SUMMARY.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-02-SUMMARY.md
@packages/api/src/services/guest-identity.ts
@packages/api/src/services/phone-normalization.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add import-channel adapters and dependencies</name>
  <files>packages/api/package.json, packages/api/src/services/guest-import-csv.ts, packages/api/src/services/guest-import-contacts.ts</files>
  <action>Add `csv-parse` dependency and implement adapters for CSV stream parsing and contacts payload mapping into a common import-row shape. Include manual-row adapter contract so UI/API can submit direct row entries without bypassing normalization. Ensure side/tag values are normalized and mapped to both Person and GuestUnit data fields consistently.</action>
  <verify>Dependencies install cleanly and package typecheck resolves adapter imports without module errors.</verify>
  <done>All import channels provide canonical rows into one shared pipeline interface.</done>
</task>

<task type="auto">
  <name>Task 2: Implement shared import pipeline with deterministic outcomes</name>
  <files>packages/api/src/services/guest-import.ts</files>
  <action>Implement ingest -> normalize -> resolve -> persist transaction flow for each row. Reuse phone normalization and `upsertGuestIdentity` for workspace-wide phone dedupe/reactivation. Persist malformed/no-phone rows as warning outcomes with `inviteable=false` rather than dropping them. For valid rows, map side/tags to both Person and GuestUnit entities and enforce one-active-membership rule. Record per-run counters/status and idempotency semantics for replay protection.</action>
  <verify>Targeted API typecheck passes and pipeline exposes typed row/run outcome summaries.</verify>
  <done>Import behavior is deterministic across channels with warning visibility and no manual re-entry requirements.</done>
</task>

<task type="auto">
  <name>Task 3: Expose import procedures and route composition</name>
  <files>packages/api/src/routers/guest-imports.ts, packages/api/src/routers/index.ts</files>
  <action>Create protected procedures for starting CSV imports, contacts imports, and manual-row imports; include list/detail endpoints for import runs and row warnings. Enforce Parent Admin + Family Coordinator role boundaries. Emit import observability audit actions around run start/completion and guest-edit impacts. Compose `guestImports` router into app router for web client consumption.</action>
  <verify>`bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds and app router exports typed `guestImports` procedures.</verify>
  <done>Import pipeline is accessible via stable API procedures with deterministic output and observability hooks.</done>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds after import pipeline wiring.
- [ ] CSV, contacts, and manual-row endpoints all call the same shared pipeline function.
- [ ] Malformed/no-phone rows persist with warning outcome and `inviteable=false`.
- [ ] Valid rows normalize side/tags for both Person and GuestUnit records.
- [ ] Import run counters include created/updated/reactivated/warning/failed totals.
</verification>

<success_criteria>
- All tasks completed.
- GST-02 import sources are supported without channel-specific data model drift.
- GST-03 dedupe behavior is consistently enforced during import execution.
</success_criteria>

<output>
After completion, create `.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-03-SUMMARY.md`.
</output>
