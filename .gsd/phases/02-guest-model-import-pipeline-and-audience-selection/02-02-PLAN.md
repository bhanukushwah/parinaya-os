---
phase: 02-guest-model-import-pipeline-and-audience-selection
plan: "02"
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - packages/api/src/services/phone-normalization.ts
  - packages/api/src/services/guest-identity.ts
  - packages/api/src/routers/guests.ts
  - packages/api/src/routers/index.ts
  - packages/api/src/policies/authorize.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Parent Admin and Family Coordinator can manage People and GuestUnits within role boundaries."
    - "Primary identity key is normalized phone only, and matching phone with different names auto-merges into one identity."
    - "Matching archived/deactivated identity is reactivated instead of creating a duplicate."
    - "Minimum required field for active invite target is phone."
  artifacts:
    - path: packages/api/src/services/phone-normalization.ts
      provides: Shared E.164 normalization/validation utility based on libphonenumber-js/max
      min_lines: 40
      contains: parsePhoneNumberWithError
    - path: packages/api/src/services/guest-identity.ts
      provides: Workspace-wide identity upsert/reactivation logic with deterministic merge behavior
      min_lines: 90
      contains: export async function upsertGuestIdentity
    - path: packages/api/src/routers/guests.ts
      provides: People and GuestUnit CRUD + assignment procedures with role enforcement
      min_lines: 180
      contains: export const guestsRouter
    - path: packages/api/src/routers/index.ts
      provides: App router composition exposing guest-domain procedures
      contains: "guests:"
  key_links:
    - from: packages/api/src/routers/guests.ts
      to: packages/api/src/policies/authorize.ts
      via: role-bound edit permissions for Parent Admin and Family Coordinator
      pattern: assertCan\(
    - from: packages/api/src/routers/guests.ts
      to: packages/api/src/services/guest-identity.ts
      via: deterministic identity upsert + reactivation before person persistence
      pattern: upsertGuestIdentity\(
    - from: packages/api/src/services/guest-identity.ts
      to: packages/db/src/schema/guests.ts
      via: transaction/upsert against workspace phone identity constraints
---

<objective>
Implement guest-domain API contracts for People and GuestUnit operations with deterministic identity semantics.

Purpose: Deliver GST-01 and core GST-03 behavior as reusable server procedures before import and audience layers are added.
Output: Guests router plus identity/normalization services that enforce workspace-wide phone-only dedupe and reactivation behavior.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-CONTEXT.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-RESEARCH.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-01-SUMMARY.md
@packages/api/src/policies/authorize.ts
@packages/api/src/services/audit-log.ts
@packages/api/src/routers/index.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add shared phone normalization service for deterministic identity keying</name>
  <files>packages/api/src/services/phone-normalization.ts</files>
  <action>Implement normalization utility using `libphonenumber-js/max` to produce canonical E.164 phone values and explicit invalid/malformed outcomes. Keep identity key derivation strictly phone-only; do not include name/email secondary matching. Return structured errors that router/import layers can persist as warning outcomes when needed.</action>
  <verify>Package-level typecheck passes and utility is importable from guest router/service modules.</verify>
  <done>All guest identity operations can rely on one canonical normalization path.</done>
</task>

<task type="auto">
  <name>Task 2: Implement workspace-wide identity upsert/reactivation domain service</name>
  <files>packages/api/src/services/guest-identity.ts</files>
  <action>Create transactional helper that resolves identity by `(workspaceId, normalizedPhone)` and performs deterministic upsert semantics: create when absent, merge/update when present, reactivate when deactivated, and never duplicate active identity. Ensure name differences update display metadata while preserving a single phone-key identity. Return outcome metadata (`created`, `updated`, `reactivated`) for import/audit reuse.</action>
  <verify>Typecheck succeeds and service returns typed deterministic outcome states used by callers.</verify>
  <done>Phone-based dedupe and reactivation rules are centralized and reusable across all ingest paths.</done>
</task>

<task type="auto">
  <name>Task 3: Add guests router for People + GuestUnit management within role boundaries</name>
  <files>packages/api/src/routers/guests.ts, packages/api/src/routers/index.ts, packages/api/src/policies/authorize.ts</files>
  <action>Implement guest procedures for create/edit/archive/list People and GuestUnits, assign/remove person membership, and maintain one-active GuestUnit membership per person per workspace. Enforce Parent Admin + Family Coordinator edit access through centralized authorization policy helpers. Guarantee active invite target eligibility requires phone availability and normalized identity linkage. Write `guest.edit` audit events for mutating operations.</action>
  <verify>`bunx tsc --noEmit -p packages/api/tsconfig.json` passes and app router exports typed `guests` domain.</verify>
  <done>Family operators can manage guest records safely with deterministic identity wiring and policy enforcement.</done>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds with new guest router/services.
- [ ] Matching normalized phone across different names resolves to a single identity within the workspace (no duplicate active identity records).
- [ ] Deactivated identity match is reactivated, not duplicated.
- [ ] Person assignment enforces one active GuestUnit membership per workspace.
- [ ] Guest mutations emit `guest.edit` audit logs.
</verification>

<success_criteria>
- All tasks completed.
- GST-01 edit/manage capabilities exist at API boundary for Parent Admin and Family Coordinator.
- Deterministic phone-only dedupe behavior is encoded in reusable service logic.
</success_criteria>

<output>
After completion, create `.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-02-SUMMARY.md`.
</output>
