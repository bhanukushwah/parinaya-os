---
phase: 02-guest-model-import-pipeline-and-audience-selection
plan: "05"
type: execute
wave: 5
depends_on:
  - "02-02"
  - "02-03"
  - "02-04"
files_modified:
  - apps/web/src/routes/dashboard.guests.tsx
  - apps/web/src/routes/dashboard.imports.tsx
  - apps/web/src/routes/dashboard.events.$eventId.audience.tsx
  - apps/web/src/routes/dashboard.tsx
  - apps/web/src/routeTree.gen.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Family Coordinator can create/manage People and assign them to GuestUnits from dashboard surfaces."
    - "Import UX supports CSV, contacts, and manual row entry using the same backend pipeline outputs."
    - "Audience builder UI applies side/tags/search filters with AND behavior plus manual include/exclude GuestUnit overrides."
    - "Pre-send recipient count shown in UI comes from server-computed unique active eligible targets after dedupe."
  artifacts:
    - path: apps/web/src/routes/dashboard.guests.tsx
      provides: People + GuestUnit management surface with assignment workflows
      min_lines: 180
      contains: createFileRoute("/dashboard/guests")
    - path: apps/web/src/routes/dashboard.imports.tsx
      provides: Import run launcher/status UI for CSV, contacts, and manual rows including warning summaries
      min_lines: 170
      contains: createFileRoute("/dashboard/imports")
    - path: apps/web/src/routes/dashboard.events.$eventId.audience.tsx
      provides: Event audience builder UI with filters, include/exclude overrides, and recipient preview count
      min_lines: 180
      contains: createFileRoute("/dashboard/events/$eventId/audience")
    - path: apps/web/src/routeTree.gen.ts
      provides: Generated route tree including new phase-02 dashboard routes
      contains: /dashboard/guests
  key_links:
    - from: apps/web/src/routes/dashboard.guests.tsx
      to: packages/api/src/routers/guests.ts
      via: oRPC queries/mutations for people and guest unit management
      pattern: orpc\.guests
    - from: apps/web/src/routes/dashboard.imports.tsx
      to: packages/api/src/routers/guest-imports.ts
      via: oRPC procedures for import execution and warning visibility
      pattern: orpc\.guestImports
    - from: apps/web/src/routes/dashboard.events.$eventId.audience.tsx
      to: packages/api/src/routers/audience.ts
      via: oRPC preview/precheck calls for deterministic recipient count
      pattern: orpc\.audience
---

<objective>
Deliver operator-facing dashboard routes for guest management, imports, and audience preview.

Purpose: Make phase-02 backend capabilities usable in real workflows for Family Coordinator and Parent Admin.
Output: New dashboard routes and route-tree wiring for People/GuestUnit operations, import execution, and event audience count preview.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-CONTEXT.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-RESEARCH.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-02-SUMMARY.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-03-SUMMARY.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-04-SUMMARY.md
@apps/web/src/utils/orpc.ts
@apps/web/src/routes/dashboard.tsx
</context>

<tasks>
<task type="auto">
  <name>Task 1: Build dashboard guest-management route for People and GuestUnits</name>
  <files>apps/web/src/routes/dashboard.guests.tsx, apps/web/src/routes/dashboard.tsx</files>
  <action>Create `/dashboard/guests` route with API-backed CRUD interactions for People and GuestUnits, including assignment/reassignment flows that preserve one active GuestUnit membership per person. Surface side/tags fields in forms and normalize submission payloads as expected by API contracts. Restrict edit controls by server auth responses; avoid client-side role assumptions beyond UX affordances.</action>
  <verify>Web typecheck passes and route renders guest data with mutation-driven refresh.</verify>
  <done>Family Coordinator can manage households and person assignments through dashboard UI.</done>
</task>

<task type="auto">
  <name>Task 2: Build imports dashboard route with warning visibility</name>
  <files>apps/web/src/routes/dashboard.imports.tsx</files>
  <action>Create `/dashboard/imports` route for launching CSV upload imports, contacts imports, and manual-row imports via corresponding API procedures. Render run status/counters and row-level warning summaries so malformed phone rows are visible and clearly marked non-inviteable. Ensure no import channel bypasses shared backend pipeline behavior.</action>
  <verify>Web typecheck passes and UI renders import run statuses with warning counts.</verify>
  <done>Operators can execute and monitor all supported import channels without manual data re-entry.</done>
</task>

<task type="auto">
  <name>Task 3: Build event audience route with deterministic count preview</name>
  <files>apps/web/src/routes/dashboard.events.$eventId.audience.tsx, apps/web/src/routeTree.gen.ts</files>
  <action>Create `/dashboard/events/$eventId/audience` route containing side/tags/search filters and explicit include/exclude GuestUnit override controls. Call server preview/precheck procedures and display returned recipient count as pre-send truth source. Keep filter UX aligned with AND semantics across active filters and show resolved recipient sample metadata where available. Regenerate and commit route tree artifacts.</action>
  <verify>`bunx tsc --noEmit -p apps/web/tsconfig.json` passes and generated route tree contains new routes.</verify>
  <done>Parent Admin can build event audiences and see accurate pre-send recipient counts in dashboard workflow.</done>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p apps/web/tsconfig.json` succeeds with new dashboard routes.
- [ ] `/dashboard/guests` supports person and guest-unit management with assignment updates reflected after refetch.
- [ ] `/dashboard/imports` supports CSV, contacts, and manual-row submissions and renders warning outcomes.
- [ ] `/dashboard/events/$eventId/audience` applies side/tags/search filters and include/exclude overrides before previewing count.
- [ ] Audience preview count displayed in UI originates from server resolver output, not client-side counting.
</verification>

<success_criteria>
- All tasks completed.
- Phase-02 success criteria are operationally visible from dashboard routes.
- UI behavior follows locked audience/dedupe/import rules without introducing deferred identity features.
</success_criteria>

<output>
After completion, create `.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-05-SUMMARY.md`.
</output>
