---
phase: 02-guest-model-import-pipeline-and-audience-selection
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/db/src/schema/guests.ts
  - packages/db/src/schema/index.ts
  - packages/db/src/migrations/*.sql
autonomous: true
user_setup: []
must_haves:
  truths:
    - "GuestUnit is a first-class household invite unit, and Person belongs to only one active GuestUnit at a time per workspace."
    - "Phone-only normalized identity is enforced workspace-wide for deterministic dedupe and active-target uniqueness."
    - "Import rows/runs persist warning and inviteability state so malformed phones are stored but never treated as inviteable targets."
  artifacts:
    - path: packages/db/src/schema/guests.ts
      provides: Guest identity, people, guest unit, membership, tags, import run, and import row schema
      min_lines: 220
      contains: export const guestIdentities
    - path: packages/db/src/schema/index.ts
      provides: Schema barrel export for guest-domain tables
      contains: export * from "./guests"
    - path: packages/db/src/migrations
      provides: Migration SQL for all phase-02 guest/import tables and indexes
  key_links:
    - from: packages/db/src/schema/guests.ts
      to: packages/db/src/schema/governance.ts
      via: createdBy/updatedBy membership references for role-bound editing and auditability
    - from: packages/db/src/schema/guests.ts
      to: packages/db/src/schema/events.ts
      via: event audience selection bindings over GuestUnit records
---

<objective>
Create the Phase 2 database foundation for guest operations, deterministic identity, and audience targeting.

Purpose: Encode GST-01/GST-02/GST-03/EVT-03 invariants directly in schema so downstream API and UI layers cannot violate locked behavior.
Output: New guest-domain schema module and generated migration SQL covering identities, people, guest units, import pipeline entities, and audience override entities.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/STATE.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-CONTEXT.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-RESEARCH.md
@packages/db/src/schema/events.ts
@packages/db/src/schema/governance.ts
@packages/db/drizzle.config.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Add deterministic guest identity and household schema primitives</name>
  <files>packages/db/src/schema/guests.ts</files>
  <action>Create guest-domain enums and tables: identities, people, guest units, guest unit membership, side/tag entities, and invite-target status fields. Enforce workspace-wide phone-key behavior by storing normalized E.164 values and adding uniqueness/index strategy that prevents duplicate active invite targets for the same normalized phone. Model one-active-membership-per-person-per-workspace constraint and GuestUnit-as-household semantics explicitly.</action>
  <verify>Schema compiles and Drizzle infers table relations/types without errors in package-level typecheck.</verify>
  <done>Core guest and household invariants are persistently enforceable by the database.</done>
</task>

<task type="auto">
  <name>Task 2: Add import run and import row observability entities</name>
  <files>packages/db/src/schema/guests.ts</files>
  <action>Add import-run and import-row tables supporting CSV, contacts, and manual-row channels. Persist row outcomes and warnings (`created`, `updated`, `reactivated`, `warning_malformed_phone`, `skipped_no_phone`) with inviteable flags so malformed phone rows remain queryable but non-inviteable. Include counters/status fields for run-level telemetry and idempotency keys to support replay safety.</action>
  <verify>New enums and tables expose typed status/outcome fields and compile through Drizzle schema build.</verify>
  <done>Import pipeline persistence can capture both successful and warning outcomes without data loss.</done>
</task>

<task type="auto">
  <name>Task 3: Export schema and generate deterministic migration SQL</name>
  <files>packages/db/src/schema/index.ts, packages/db/src/migrations/*.sql</files>
  <action>Wire new guest schema into schema barrel exports and run `bun run db:generate` to emit migration artifacts. Ensure generated SQL includes unique/index constraints for phone dedupe scope, one-active-membership constraints, and import observability tables required by phase behavior.</action>
  <verify>`bun run db:generate` succeeds and migration files are created under `packages/db/src/migrations` for phase-02 schema additions.</verify>
  <done>Phase-02 data model is migration-backed and consumable by API routes.</done>
</task>
</tasks>

<verification>
- [ ] `bun run db:generate` succeeds and creates migration SQL for all guest/import entities.
- [ ] `bunx tsc --noEmit -p packages/db/tsconfig.json` succeeds.
- [ ] Schema enforces workspace-scoped deterministic phone identity and one-active GuestUnit membership for each person.
- [ ] Malformed/no-phone import rows can persist with non-inviteable warning state.
</verification>

<success_criteria>
- All tasks completed.
- Database primitives fully represent locked phase context decisions without deferred behavior.
- Schema + migration artifacts are ready for API implementation of guest management/import/audience.
</success_criteria>

<output>
After completion, create `.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-01-SUMMARY.md`.
</output>
