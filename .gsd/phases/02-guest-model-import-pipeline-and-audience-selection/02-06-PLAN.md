---
phase: 02-guest-model-import-pipeline-and-audience-selection
plan: "06"
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/api/src/services/audience-builder.ts
  - packages/api/src/routers/audience.ts
autonomous: true
user_setup: []
gap_closure: true
must_haves:
  truths:
    - "Audience preview and pre-send precheck still produce identical recipient counts for identical inputs."
    - "Audience builder owns audience-to-recipient wiring so router cannot diverge from resolver path."
    - "Service-level wiring remains deterministic for side/tags/search filters plus include/exclude overrides."
  artifacts:
    - path: packages/api/src/services/audience-builder.ts
      provides: Audience service that wires filtered GuestUnits into recipient resolution
      min_lines: 160
      contains: resolveRecipients(
    - path: packages/api/src/routers/audience.ts
      provides: Router procedures delegating recipient resolution through audience service output
      min_lines: 120
      contains: export const audienceRouter
  key_links:
    - from: packages/api/src/services/audience-builder.ts
      to: packages/api/src/services/recipient-resolver.ts
      via: Filtered audience candidates are resolved by shared recipient resolver inside service layer
      pattern: resolveRecipients\(
    - from: packages/api/src/routers/audience.ts
      to: packages/api/src/services/audience-builder.ts
      via: Preview and precheck call one service entry point and consume returned recipient details
      pattern: buildAudience\(
---

<objective>
Close the Phase 02 verification gap by aligning key-link wiring between audience-builder and recipient-resolver.

Purpose: Remove structural drift between declared must_haves and implementation so verification passes without changing product behavior.
Output: Audience service refactor and router wiring update that preserves current recipient-count behavior.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-VERIFICATION.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-04-PLAN.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-04-SUMMARY.md
@packages/api/src/services/audience-builder.ts
@packages/api/src/services/recipient-resolver.ts
@packages/api/src/routers/audience.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Move audience-to-recipient wiring into audience service</name>
  <files>packages/api/src/services/audience-builder.ts</files>
  <action>Refactor `buildAudience` service boundary so filtered GuestUnit candidates are resolved through `resolveRecipients(...)` within the service module. Keep side/tags/search AND semantics and include/exclude override behavior unchanged. Return data shape that includes both audience candidate context and resolver output needed by preview/precheck callers.</action>
  <verify>Service compiles, includes explicit `resolveRecipients(...)` call, and preserves deterministic output for identical inputs.</verify>
  <done>Gap key-link is closed at service layer while audience behavior remains unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Update audience router to consume unified service output</name>
  <files>packages/api/src/routers/audience.ts</files>
  <action>Update preview and precheck procedures to use the audience service as the source for recipient resolution results, removing direct resolver invocation from router control flow. Keep response contract stable for dashboard consumers and ensure both procedures stay on identical computation path.</action>
  <verify>`bunx tsc --noEmit -p packages/api/tsconfig.json` passes and router no longer performs independent resolver orchestration.</verify>
  <done>Router/service wiring matches declared architecture and count behavior remains consistent.</done>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds after refactor.
- [ ] `packages/api/src/services/audience-builder.ts` contains an active `resolveRecipients(...)` call in execution path.
- [ ] `packages/api/src/routers/audience.ts` preview and precheck both consume service-produced recipient results.
- [ ] For the same filter + override input, preview and precheck still return matching recipient counts.
</verification>

<success_criteria>
- Gap in `02-VERIFICATION.md` section "02-04 key link mismatch" is concretely addressed.
- Structural wiring now matches plan key-link expectation.
- No regression in deterministic audience recipient counting behavior.
</success_criteria>

<output>
After completion, create `.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-06-SUMMARY.md`.
</output>
