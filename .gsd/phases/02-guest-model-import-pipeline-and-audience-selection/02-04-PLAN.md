---
phase: 02-guest-model-import-pipeline-and-audience-selection
plan: "04"
type: execute
wave: 4
depends_on:
  - "02-01"
  - "02-02"
  - "02-03"
files_modified:
  - packages/api/src/services/recipient-resolver.ts
  - packages/api/src/services/audience-builder.ts
  - packages/api/src/routers/audience.ts
  - packages/api/src/routers/index.ts
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Audience filters combine side + tags + search with AND semantics across active filters."
    - "Manual override supports explicit include and exclude of GuestUnit records."
    - "Pre-send recipient count equals unique active eligible invite targets after dedupe and eligibility checks."
    - "Delivery resolution uses GuestUnit target first, then per-person fallback if missing."
  artifacts:
    - path: packages/api/src/services/recipient-resolver.ts
      provides: Shared delivery target resolver used by preview count and send-precheck
      min_lines: 110
      contains: export async function resolveRecipients
    - path: packages/api/src/services/audience-builder.ts
      provides: Deterministic audience filtering pipeline with side/tags/search and include/exclude overrides
      min_lines: 140
      contains: export async function buildAudience
    - path: packages/api/src/routers/audience.ts
      provides: Audience preview and pre-send endpoints with count + resolved-target output
      min_lines: 120
      contains: export const audienceRouter
    - path: packages/api/src/routers/index.ts
      provides: App router composition exposing audience-domain procedures
      contains: "audience:"
  key_links:
    - from: packages/api/src/routers/audience.ts
      to: packages/api/src/services/audience-builder.ts
      via: preview and precheck requests share identical audience construction logic
      pattern: buildAudience\(
    - from: packages/api/src/services/audience-builder.ts
      to: packages/api/src/services/recipient-resolver.ts
      via: filtered units pass through shared recipient resolution for count correctness
      pattern: resolveRecipients\(
    - from: packages/api/src/services/recipient-resolver.ts
      to: packages/db/src/schema/guests.ts
      via: GuestUnit-first then Person-fallback delivery phone resolution
---

<objective>
Implement deterministic audience building and recipient-count resolution for event invite targeting.

Purpose: Deliver EVT-03 with server-side correctness guarantees so preview and send-precheck never diverge.
Output: Audience + recipient resolver services and audience router procedures for preview and pre-send validation.
</objective>

<execution_context>
@~/.kilocode/skills/execute-plan/SKILL.md
@.gsd/templates/summary.md
</execution_context>

<context>
@.gsd/ROADMAP.md
@.gsd/REQUIREMENTS.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-CONTEXT.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-RESEARCH.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-02-SUMMARY.md
@.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-03-SUMMARY.md
@packages/api/src/services/guest-identity.ts
</context>

<tasks>
<task type="auto">
  <name>Task 1: Build deterministic audience filter service</name>
  <files>packages/api/src/services/audience-builder.ts</files>
  <action>Implement server-side query pipeline that starts from active GuestUnits in workspace, applies side/tags/search filters with AND semantics across active filters, then applies manual include/exclude override lists by GuestUnit ID. Ensure side/tags normalization behavior remains consistent with import/guest management paths. Return both filtered GuestUnit IDs and trace metadata for UI transparency.</action>
  <verify>Service compiles and exposes deterministic output for equivalent input sets.</verify>
  <done>Audience candidate set generation follows locked filter semantics exactly.</done>
</task>

<task type="auto">
  <name>Task 2: Implement shared recipient resolution for preview and send precheck</name>
  <files>packages/api/src/services/recipient-resolver.ts</files>
  <action>Create resolver that turns candidate GuestUnit IDs into delivery targets using hybrid fallback: GuestUnit-level target phone first, otherwise active member person phones. Enforce inviteability/eligibility checks and dedupe by normalized phone so final count reflects unique active eligible invite targets only. Keep this resolver reusable for both preview count and future invite-send execution.</action>
  <verify>Typecheck passes and resolver returns deterministic unique target sets from identical inputs.</verify>
  <done>Recipient-count correctness path exists as one shared function for preview and pre-send checks.</done>
</task>

<task type="auto">
  <name>Task 3: Expose audience preview + precheck APIs and compose router</name>
  <files>packages/api/src/routers/audience.ts, packages/api/src/routers/index.ts</files>
  <action>Create protected audience procedures accepting event/workspace context, side/tags/search filters, and include/exclude GuestUnit overrides. Use `buildAudience` + `resolveRecipients` in both preview and pre-send routes to prevent count drift. Return recipient count and resolved target sample metadata. Compose `audience` router into app router for dashboard consumption.</action>
  <verify>`bunx tsc --noEmit -p packages/api/tsconfig.json` passes and router exports typed preview/precheck procedures.</verify>
  <done>Parent Admin can request accurate pre-send recipient counts from a deterministic server pipeline.</done>
</task>
</tasks>

<verification>
- [ ] `bunx tsc --noEmit -p packages/api/tsconfig.json` succeeds with audience services/routes.
- [ ] Active filters execute with strict AND semantics (side + tags + search).
- [ ] Manual include/exclude GuestUnit overrides are applied after base filtering.
- [ ] Preview and pre-send procedures call the same recipient resolver path.
- [ ] Recipient count equals unique active eligible targets after dedupe + delivery fallback.
</verification>

<success_criteria>
- All tasks completed.
- EVT-03 audience targeting logic is server-deterministic and aligned with locked decisions.
- Recipient counts are preview/send-consistent because both use shared resolver logic.
</success_criteria>

<output>
After completion, create `.gsd/phases/02-guest-model-import-pipeline-and-audience-selection/02-04-SUMMARY.md`.
</output>
